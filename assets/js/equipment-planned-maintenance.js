// 计划性维护管理 - JavaScript实现（第1部分）
let currentView='calendar',currentDate=new Date(),maintenanceStrategies=[],sopLibrary=[],maintenanceTasks=[],filteredTasks=[],currentPage=1,pageSize=10;document.addEventListener('DOMContentLoaded',function(){initializeData();renderCalendar();updateStatistics();setupEventListeners()});function setupEventListeners(){document.getElementById('filter-keyword')?.addEventListener('input',debounce(applyFilters,300));document.getElementById('filter-type')?.addEventListener('change',applyFilters);document.getElementById('filter-status')?.addEventListener('change',applyFilters)}function debounce(func,wait){let timeout;return function executedFunction(...args){clearTimeout(timeout);timeout=setTimeout(()=>func(...args),wait)}}function switchView(viewType){currentView=viewType;['calendar','list','strategy'].forEach(type=>{const btn=document.getElementById(`view-${type}`);if(btn){if(type===viewType){btn.classList.add('bg-primary','text-white');btn.classList.remove('bg-white','text-gray-700')}else{btn.classList.remove('bg-primary','text-white');btn.classList.add('bg-white','text-gray-700')}}});document.querySelectorAll('.view-content').forEach(el=>el.classList.add('hidden'));document.getElementById(`view-${viewType}-content`)?.classList.remove('hidden');if(viewType==='calendar'){renderCalendar()}else if(viewType==='list'){renderTaskList()}else if(viewType==='strategy'){renderStrategyView()}}function renderCalendar(){const year=currentDate.getFullYear(),month=currentDate.getMonth();document.getElementById('calendar-title').textContent=`${year}年${month+1}月`;const firstDay=new Date(year,month,1),lastDay=new Date(year,month+1,0),startDay=firstDay.getDay(),daysInMonth=lastDay.getDate(),grid=document.getElementById('calendar-grid');grid.innerHTML='';const weekDays=['日','一','二','三','四','五','六'];weekDays.forEach(day=>{const header=document.createElement('div');header.className='text-center font-semibold text-gray-700 py-2';header.textContent=day;grid.appendChild(header)});for(let i=0;i<startDay;i++){const emptyDay=document.createElement('div');emptyDay.className='calendar-day bg-gray-50';grid.appendChild(emptyDay)}const today=new Date();for(let day=1;day<=daysInMonth;day++){const dayCell=document.createElement('div'),currentDayDate=new Date(year,month,day),isToday=currentDayDate.toDateString()===today.toDateString();dayCell.className=`calendar-day ${isToday?'today':''}`;dayCell.onclick=()=>showDayTasks(year,month,day);const dayNumber=document.createElement('div');dayNumber.className='font-semibold text-gray-800 mb-1';dayNumber.textContent=day;dayCell.appendChild(dayNumber);const dayTasks=maintenanceTasks.filter(task=>{const taskDate=new Date(task.planDate);return taskDate.getFullYear()===year&&taskDate.getMonth()===month&&taskDate.getDate()===day});dayTasks.slice(0,3).forEach(task=>{const taskBadge=document.createElement('div');taskBadge.className=`task-badge ${getStatusClass(task.status)}`;taskBadge.textContent=task.equipmentName.substring(0,6);taskBadge.title=task.equipmentName;dayCell.appendChild(taskBadge)});if(dayTasks.length>3){const more=document.createElement('div');more.className='text-xs text-gray-500 mt-1';more.textContent=`+${dayTasks.length-3}个任务`;dayCell.appendChild(more)}grid.appendChild(dayCell)}}function previousMonth(){currentDate.setMonth(currentDate.getMonth()-1);renderCalendar()}function nextMonth(){currentDate.setMonth(currentDate.getMonth()+1);renderCalendar()}function showDayTasks(year,month,day){const dayTasks=maintenanceTasks.filter(task=>{const taskDate=new Date(task.planDate);return taskDate.getFullYear()===year&&taskDate.getMonth()===month&&taskDate.getDate()===day});if(dayTasks.length===0){alert(`${year}-${month+1}-${day} 无保养任务`);return}const taskList=dayTasks.map(task=>`• ${task.equipmentName} - ${task.sopName} (${getStatusText(task.status)})`).join('\n');alert(`${year}-${month+1}-${day} 的保养任务:\n\n${taskList}`)}function renderTaskList(){const tbody=document.getElementById('task-tbody'),dataToRender=filteredTasks.length>0?filteredTasks:maintenanceTasks,start=(currentPage-1)*pageSize,end=start+pageSize,pageData=dataToRender.slice(start,end);if(pageData.length===0){tbody.innerHTML='<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">暂无保养任务</td></tr>';updatePagination(0);return}tbody.innerHTML=pageData.map(task=>`<tr class="hover:bg-gray-50"><td class="px-4 py-3"><input type="checkbox" class="rounded task-checkbox" data-id="${task.id}" onchange="updateSelectedCount()"></td><td class="px-4 py-3"><div class="font-medium text-primary cursor-pointer hover:text-blue-700" onclick="openTaskDetail(${task.id})">${task.code}</div><div class="text-xs text-gray-500">${task.strategyName}</div></td><td class="px-4 py-3"><div class="font-medium text-gray-800">${task.equipmentName}</div><div class="text-xs text-gray-500">${task.equipmentCode} | ${task.location}</div></td><td class="px-4 py-3"><div class="text-sm text-gray-700">${task.sopName}</div><div class="text-xs text-gray-500">${task.itemCount}个检查项 | 预计${task.estimatedHours}小时</div></td><td class="px-4 py-3"><div class="text-sm text-gray-700">${task.planDate}</div>${task.actualDate?`<div class="text-xs text-gray-500">实际: ${task.actualDate}</div>`:''}</td><td class="px-4 py-3"><div class="text-sm text-gray-700">${task.assignee||'待派发'}</div></td><td class="px-4 py-3"><span class="badge ${getStatusClass(task.status)}">${getStatusText(task.status)}</span></td><td class="px-4 py-3"><div class="flex flex-wrap gap-1"><button onclick="openTaskDetail(${task.id})" class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200" title="查看详情"><i class="fas fa-eye"></i></button><button onclick="assignTask(${task.id})" class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200" title="派发"><i class="fas fa-user-check"></i></button><button onclick="executeTask(${task.id})" class="text-xs px-2 py-1 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200" title="执行"><i class="fas fa-play"></i></button><button onclick="deleteTask(${task.id})" class="text-xs px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200" title="删除"><i class="fas fa-trash"></i></button></div></td></tr>`).join('');updatePagination(dataToRender.length)}function renderStrategyView(){const strategyList=document.getElementById('strategy-list'),sopList=document.getElementById('sop-list');if(maintenanceStrategies.length===0){strategyList.innerHTML='<p class="text-center text-gray-500 py-8">暂无保养策略</p>'}else{strategyList.innerHTML=maintenanceStrategies.map(strategy=>`<div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="editStrategy(${strategy.id})"><div class="flex items-start justify-between mb-2"><h4 class="font-semibold text-gray-800">${strategy.name}</h4><span class="badge ${getTypeClass(strategy.type)}">${getTypeText(strategy.type)}</span></div><p class="text-sm text-gray-600 mb-2">${strategy.description}</p><div class="flex items-center justify-between text-xs text-gray-500"><span><i class="fas fa-calendar mr-1"></i>${strategy.frequency}</span><span><i class="fas fa-microchip mr-1"></i>${strategy.equipmentCount}台设备</span><span class="${strategy.active?'text-green-600':'text-gray-400'}">${strategy.active?'启用':'停用'}</span></div></div>`).join('')}if(sopLibrary.length===0){sopList.innerHTML='<p class="text-center text-gray-500 py-8">暂无SOP基准</p>'}else{sopList.innerHTML=sopLibrary.map(sop=>`<div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="editSOP(${sop.id})"><div class="flex items-start justify-between mb-2"><h4 class="font-semibold text-gray-800">${sop.name}</h4><span class="text-xs text-gray-500">${sop.itemCount}项</span></div><div class="flex items-center justify-between text-xs text-gray-500"><span><i class="fas fa-tag mr-1"></i>${sop.category}</span><span><i class="fas fa-clock mr-1"></i>预计${sop.estimatedHours}小时</span><span><i class="fas fa-link mr-1"></i>被${sop.usageCount}个策略使用</span></div></div>`).join('')}}function applyFilters(){const keyword=document.getElementById('filter-keyword')?.value.toLowerCase()||'',type=document.getElementById('filter-type')?.value||'',status=document.getElementById('filter-status')?.value||'';filteredTasks=maintenanceTasks.filter(task=>{const matchKeyword=!keyword||task.equipmentName.toLowerCase().includes(keyword)||task.strategyName.toLowerCase().includes(keyword);const matchType=!type||task.strategyType===type;const matchStatus=!status||task.status===status;return matchKeyword&&matchType&&matchStatus});currentPage=1;if(currentView==='list'){renderTaskList()}}function resetFilters(){document.getElementById('filter-keyword').value='';document.getElementById('filter-type').value='';document.getElementById('filter-status').value='';filteredTasks=[];currentPage=1;if(currentView==='list'){renderTaskList()}}function openModal(modalType){const modal=document.getElementById(`modal-${modalType}`);if(modal){modal.classList.add('show');document.body.style.overflow='hidden'}}function closeModal(modalType){const modal=document.getElementById(`modal-${modalType}`);if(modal){modal.classList.remove('show');document.body.style.overflow='auto'}}function openStrategyForm(strategyId=null){if(strategyId){const strategy=maintenanceStrategies.find(s=>s.id===strategyId);if(strategy){document.getElementById('form-strategy-name').value=strategy.name;document.getElementById('form-strategy-type').value=strategy.type;document.getElementById('form-strategy-frequency').value=strategy.frequency;document.getElementById('form-strategy-description').value=strategy.description}}else{document.getElementById('strategy-form').reset()}openModal('strategy-form')}function saveStrategy(){const formData={id:Date.now(),name:document.getElementById('form-strategy-name').value,type:document.getElementById('form-strategy-type').value,frequency:document.getElementById('form-strategy-frequency').value,description:document.getElementById('form-strategy-description').value,equipmentCount:0,active:true,createTime:new Date().toISOString()};maintenanceStrategies.unshift(formData);closeModal('strategy-form');updateStatistics();alert('保养策略创建成功！')}function editStrategy(strategyId){openStrategyForm(strategyId)}function openSOPForm(sopId=null){if(sopId){const sop=sopLibrary.find(s=>s.id===sopId);if(sop){document.getElementById('form-sop-name').value=sop.name;document.getElementById('form-sop-category').value=sop.category;document.getElementById('form-sop-hours').value=sop.estimatedHours}}else{document.getElementById('sop-form').reset();document.getElementById('sop-items-list').innerHTML=''}openModal('sop-form')}function addSOPItem(){const itemsList=document.getElementById('sop-items-list'),itemId=Date.now(),itemHTML=`<div class="flex gap-2 items-center p-2 border rounded" id="sop-item-${itemId}"><input type="text" placeholder="检查项目" class="flex-1 px-2 py-1 border rounded text-sm"><input type="text" placeholder="标准" class="flex-1 px-2 py-1 border rounded text-sm"><button type="button" onclick="removeSOPItem(${itemId})" class="text-red-600 hover:text-red-700"><i class="fas fa-times"></i></button></div>`;itemsList.insertAdjacentHTML('beforeend',itemHTML)}function removeSOPItem(itemId){document.getElementById(`sop-item-${itemId}`)?.remove()}function saveSOP(){const formData={id:Date.now(),name:document.getElementById('form-sop-name').value,category:document.getElementById('form-sop-category').value,estimatedHours:parseFloat(document.getElementById('form-sop-hours').value)||0,itemCount:document.querySelectorAll('#sop-items-list > div').length,usageCount:0,createTime:new Date().toISOString()};sopLibrary.unshift(formData);closeModal('sop-form');alert('SOP基准创建成功！')}function editSOP(sopId){openSOPForm(sopId)}function openTaskForm(){document.getElementById('task-form').reset();document.getElementById('form-task-code').value=generateTaskCode();openModal('task-form')}function generateTaskCode(){const date=new Date(),dateStr=date.toISOString().slice(0,10).replace(/-/g,''),random=Math.floor(Math.random()*1000).toString().padStart(3,'0');return`PM-${dateStr}-${random}`}function saveTask(){const formData={id:Date.now(),code:document.getElementById('form-task-code').value,planDate:document.getElementById('form-task-date').value,equipmentName:document.getElementById('form-task-equipment').value,equipmentCode:'EQ-'+Math.floor(Math.random()*1000),location:'A车间',sopName:'SOP示例',strategyName:'月度保养',strategyType:'time',itemCount:10,estimatedHours:2,status:'pending',createTime:new Date().toISOString()};maintenanceTasks.unshift(formData);closeModal('task-form');updateStatistics();renderCalendar();alert('保养任务创建成功！')}function openTaskDetail(taskId){const task=maintenanceTasks.find(t=>t.id===taskId);if(!task)return;const detailContent=document.getElementById('task-detail-content');detailContent.innerHTML=`<div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-gray-50 border rounded-lg p-4"><h3 class="font-semibold text-gray-700 mb-3">任务信息</h3><div class="space-y-2 text-sm"><div class="flex justify-between"><span class="text-gray-500">任务编号:</span><span class="font-medium">${task.code}</span></div><div class="flex justify-between"><span class="text-gray-500">计划日期:</span><span class="font-medium">${task.planDate}</span></div><div class="flex justify-between"><span class="text-gray-500">任务状态:</span><span class="badge ${getStatusClass(task.status)}">${getStatusText(task.status)}</span></div><div class="flex justify-between"><span class="text-gray-500">执行人:</span><span class="font-medium">${task.assignee||'待派发'}</span></div></div></div><div class="bg-gray-50 border rounded-lg p-4"><h3 class="font-semibold text-gray-700 mb-3">设备信息</h3><div class="space-y-2 text-sm"><div class="flex justify-between"><span class="text-gray-500">设备名称:</span><span class="font-medium">${task.equipmentName}</span></div><div class="flex justify-between"><span class="text-gray-500">设备编码:</span><span class="font-medium">${task.equipmentCode}</span></div><div class="flex justify-between"><span class="text-gray-500">所在位置:</span><span class="font-medium">${task.location}</span></div></div></div><div class="md:col-span-2 bg-gray-50 border rounded-lg p-4"><h3 class="font-semibold text-gray-700 mb-3">保养内容</h3><div class="space-y-2 text-sm"><div class="flex justify-between"><span class="text-gray-500">SOP名称:</span><span class="font-medium">${task.sopName}</span></div><div class="flex justify-between"><span class="text-gray-500">检查项数:</span><span class="font-medium">${task.itemCount}项</span></div><div class="flex justify-between"><span class="text-gray-500">预计工时:</span><span class="font-medium">${task.estimatedHours}小时</span></div></div></div></div>`;openModal('task-detail')}function assignTask(taskId){const task=maintenanceTasks.find(t=>t.id===taskId);if(task){task.status='assigned';task.assignee='李工';renderTaskList();alert('任务已派发给李工')}}function executeTask(taskId){alert('移动端执行功能开发中...')}function deleteTask(taskId){if(confirm('确定要删除这个保养任务吗？')){const index=maintenanceTasks.findIndex(t=>t.id===taskId);if(index>-1){maintenanceTasks.splice(index,1);renderTaskList();updateStatistics();alert('任务已删除')}}}function updatePagination(totalCount){const totalPages=Math.ceil(totalCount/pageSize),start=(currentPage-1)*pageSize+1,end=Math.min(currentPage*pageSize,totalCount);document.getElementById('pagination-range').textContent=totalCount>0?`${start} - ${end}`:'0 - 0';document.getElementById('pagination-total').textContent=totalCount;const pagesContainer=document.getElementById('pagination-pages');let pagesHTML='';for(let i=1;i<=totalPages;i++){if(i===1||i===totalPages||(i>=currentPage-1&&i<=currentPage+1)){pagesHTML+=`<button class="px-3 py-1 ${i===currentPage?'bg-primary text-white':'border'} rounded text-sm hover:bg-gray-50" onclick="goToPage(${i})">${i}</button>`}else if(i===currentPage-2||i===currentPage+2){pagesHTML+=`<span class="px-2">...</span>`}}pagesContainer.innerHTML=pagesHTML}function changePage(direction){const dataToRender=filteredTasks.length>0?filteredTasks:maintenanceTasks,totalPages=Math.ceil(dataToRender.length/pageSize);if(direction==='prev'&&currentPage>1){currentPage--}else if(direction==='next'&&currentPage<totalPages){currentPage++}renderTaskList()}function goToPage(page){currentPage=page;renderTaskList()}function toggleSelectAll(checkbox){document.querySelectorAll('.task-checkbox').forEach(cb=>cb.checked=checkbox.checked);updateSelectedCount()}function updateSelectedCount(){const count=document.querySelectorAll('.task-checkbox:checked').length;document.getElementById('selected-count').textContent=count}function batchAssign(){const selected=document.querySelectorAll('.task-checkbox:checked');if(selected.length===0){alert('请先选择任务');return}alert(`批量派发 ${selected.length} 个任务`)}function batchExport(){const selected=document.querySelectorAll('.task-checkbox:checked');if(selected.length===0){alert('请先选择任务');return}alert(`批量导出 ${selected.length} 个任务`)}function updateStatistics(){document.getElementById('metric-strategies').textContent=maintenanceStrategies.filter(s=>s.active).length;document.getElementById('metric-tasks').textContent=maintenanceTasks.length;document.getElementById('metric-pending').textContent=maintenanceTasks.filter(t=>t.status==='pending'||t.status==='assigned').length;const completed=maintenanceTasks.filter(t=>t.status==='completed').length,total=maintenanceTasks.length,completionRate=total>0?Math.round((completed/total)*100):0;document.getElementById('metric-completion').textContent=`${completionRate}%`}function getStatusText(status){const map={pending:'待派发',assigned:'已派发',in_progress:'执行中',completed:'已完成',cancelled:'已取消'};return map[status]||status}function getStatusClass(status){const map={pending:'bg-orange-100 text-orange-700',assigned:'bg-blue-100 text-blue-700',in_progress:'bg-yellow-100 text-yellow-700',completed:'bg-green-100 text-green-700',cancelled:'bg-gray-100 text-gray-700'};return map[status]||'bg-gray-100 text-gray-700'}function getTypeText(type){const map={time:'基于时间',usage:'基于用量',condition:'基于状态'};return map[type]||type}function getTypeClass(type){const map={time:'bg-blue-100 text-blue-700',usage:'bg-green-100 text-green-700',condition:'bg-purple-100 text-purple-700'};return map[type]||'bg-gray-100 text-gray-700'}function exportData(){alert('导出功能开发中...')}function initializeData(){maintenanceStrategies=[{id:1,name:'逆变器测试台月度保养',type:'time',frequency:'每月1号',description:'对所有逆变器老化测试台进行月度保养',equipmentCount:8,active:true,createTime:'2025-01-01'},{id:2,name:'CNC机床500小时保养',type:'usage',frequency:'每运行500小时',description:'CNC机床刀具更换和精度校准',equipmentCount:12,active:true,createTime:'2025-01-05'}];sopLibrary=[{id:1,name:'逆变器老化测试台月度保养SOP',category:'测试设备',estimatedHours:2,itemCount:10,usageCount:1,createTime:'2025-01-01'},{id:2,name:'CNC机床刀具更换SOP',category:'加工设备',estimatedHours:1.5,itemCount:8,usageCount:1,createTime:'2025-01-05'}];maintenanceTasks=[{id:1,code:'PM-20250130-001',planDate:'2025-01-30',equipmentName:'逆变器老化测试台',equipmentCode:'EQ-2024-019',location:'B车间',sopName:'逆变器老化测试台月度保养SOP',strategyName:'逆变器测试台月度保养',strategyType:'time',itemCount:10,estimatedHours:2,status:'assigned',assignee:'李工',createTime:'2025-01-25'},{id:2,code:'PM-20250131-002',planDate:'2025-01-31',equipmentName:'CNC加工中心',equipmentCode:'EQ-2024-045',location:'C车间',sopName:'CNC机床刀具更换SOP',strategyName:'CNC机床500小时保养',strategyType:'usage',itemCount:8,estimatedHours:1.5,status:'pending',createTime:'2025-01-26'},{id:3,code:'PM-20250201-003',planDate:'2025-02-01',equipmentName:'全自动贴片机',equipmentCode:'EQ-2024-001',location:'A车间',sopName:'贴片机月度保养SOP',strategyName:'贴片机月度保养',strategyType:'time',itemCount:12,estimatedHours:3,status:'completed',assignee:'王工',actualDate:'2025-01-28',createTime:'2025-01-20'}]}
