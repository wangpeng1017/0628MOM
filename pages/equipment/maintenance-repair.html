<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>维护维修管理 - 设备管理 - 数字工厂一体化平台</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#1e40af',
                        'primary-light': '#3b82f6',
                        'secondary': '#6b7280',
                        'success': '#10b981',
                        'warning': '#f59e0b',
                        'danger': '#ef4444'
                    }
                }
            }
        }
    </script>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tab-button {
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #2563eb;
            font-weight: 600;
        }

        .status-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .kanban-item {
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            background-color: #ffffff;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .kanban-item:hover {
            border-color: #bfdbfe;
            background-color: #eff6ff;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .timeline-item {
            position: relative;
            padding-left: 2rem;
            margin-bottom: 1.5rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.6rem;
            top: 0.4rem;
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 9999px;
            background-color: #2563eb;
        }

        .timeline-item::after {
            content: '';
            position: absolute;
            left: 0.95rem;
            top: 1.25rem;
            width: 1px;
            height: calc(100% - 1.25rem);
            background-color: #d1d5db;
        }

        .timeline-item:last-child::after {
            display: none;
        }

        .tag {
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: rgba(148, 163, 184, 0.5);
            border-radius: 9999px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">
        <!-- 主内容区（全宽） -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <div class="bg-white border-b p-6">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">维护维修管理</span>
                            <span class="text-xs text-gray-500">Process.md 2.4.10 全流程闭环</span>
                        </div>
                        <div class="flex items-center gap-4 mb-2">
                            <h1 class="text-2xl font-bold text-gray-800">维修调度工作台</h1>
                            <div class="flex gap-1 border rounded-lg p-1">
                                <button id="view-kanban" class="px-3 py-1 text-xs bg-primary text-white rounded hover:bg-blue-700 transition-colors" onclick="switchBoardView('kanban')">
                                    <i class="fas fa-columns mr-1"></i>看板
                                </button>
                                <button id="view-list" class="px-3 py-1 text-xs bg-white text-gray-700 rounded hover:bg-gray-100 transition-colors" onclick="switchBoardView('list')">
                                    <i class="fas fa-list-ul mr-1"></i>列表
                                </button>
                                <button id="view-calendar" class="px-3 py-1 text-xs bg-white text-gray-700 rounded hover:bg-gray-100 transition-colors" onclick="switchBoardView('calendar')">
                                    <i class="fas fa-calendar-alt mr-1"></i>日历
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600">覆盖报修 → 派工 → 执行 → 验收 → 知识沉淀的全闭环管理</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="openWorkOrderForm()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-plus mr-2"></i>新建工单
                        </button>
                        <button onclick="openAssignModal()" class="px-4 py-2 bg-success text-white rounded-lg hover:bg-green-700 transition-colors flex items-center">
                            <i class="fas fa-user-check mr-2"></i>派工
                        </button>
                        <button onclick="openProgressModal()" class="px-4 py-2 bg-warning text-white rounded-lg hover:bg-yellow-600 transition-colors flex items-center">
                            <i class="fas fa-clock-rotate-left mr-2"></i>进度更新
                        </button>
                        <button onclick="openKnowledgeModal()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center">
                            <i class="fas fa-book mr-2"></i>故障知识库
                        </button>
                        <button onclick="exportWorkOrders()" class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center">
                            <i class="fas fa-download mr-2"></i>导出
                        </button>
                    </div>
                </div>

                <!-- 统计卡片 -->
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-blue-600 font-medium">工单总量</p>
                                <p id="metric-total" class="text-2xl font-bold text-blue-700">0</p>
                                <p class="text-xs text-blue-500 mt-1">含IoT自动报修</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-clipboard-list text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-red-600 font-medium">响应中紧急工单</p>
                                <p id="metric-urgent" class="text-2xl font-bold text-red-700">0</p>
                                <p class="text-xs text-red-500 mt-1">目标响应 ≤ 10 分钟</p>
                            </div>
                            <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-siren-on text-red-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-green-600 font-medium">本月关闭</p>
                                <p id="metric-closed" class="text-2xl font-bold text-green-700">0</p>
                                <p class="text-xs text-green-500 mt-1">验收通过+知识沉淀</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-circle-check text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-purple-600 font-medium">平均响应时间</p>
                                <p id="metric-response" class="text-2xl font-bold text-purple-700">0</p>
                                <p class="text-xs text-purple-500 mt-1">近30天实时统计</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-stopwatch text-purple-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 筛选器 -->
            <div class="bg-white border-b p-4">
                <div class="flex flex-wrap gap-3">
                    <input type="text" id="filter-code" placeholder="工单编号/设备名称" class="flex-1 min-w-[200px] px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-primary-light focus:border-transparent">
                    <select id="filter-status" class="w-44 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-primary-light focus:border-transparent">
                        <option value="">全部状态</option>
                        <option value="waiting_response">待响应</option>
                        <option value="pending_dispatch">待派工</option>
                        <option value="in_progress">进行中</option>
                        <option value="pending_acceptance">待验收</option>
                        <option value="closed">已关闭</option>
                    </select>
                    <select id="filter-priority" class="w-40 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-primary-light focus;border-transparent">
                        <option value="">全部优先级</option>
                        <option value="urgent">紧急</option>
                        <option value="high">高</option>
                        <option value="medium">中</option>
                        <option value="low">低</option>
                    </select>
                    <select id="filter-fault" class="w-44 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-primary-light focus:border-transparent">
                        <option value="">故障类型</option>
                        <option value="electrical">电气故障</option>
                        <option value="mechanical">机械故障</option>
                        <option value="calibration">校准问题</option>
                        <option value="software">软件故障</option>
                    </select>
                    <input type="date" id="filter-start-date" class="w-40 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-primary-light focus:border-transparent">
                    <input type="date" id="filter-end-date" class="w-40 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-primary-light focus:border-transparent">
                    <button onclick="applyFilters()" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-search mr-2"></i>查询
                    </button>
                    <button onclick="resetFilters()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        <i class="fas fa-redo mr-2"></i>重置
                    </button>
                </div>
            </div>

            <!-- 工单列表 -->
            <div class="flex-1 overflow-auto p-6">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="p-4 border-b flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="select-all" class="rounded" onclick="toggleSelectAll(this)">
                            <span class="text-sm text-gray-600">已选择 <span id="selected-count" class="font-semibold text-primary">0</span> 条工单</span>
                            <div id="bulk-actions" class="hidden md:flex items-center gap-2">
                                <button onclick="bulkDispatch()" class="text-sm text-success hover:text-green-700">
                                    <i class="fas fa-share-from-square mr-1"></i>批量派工
                                </button>
                                <button onclick="bulkExport()" class="text-sm text-primary hover:text-blue-700">
                                    <i class="fas fa-file-export mr-1"></i>批量导出
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 text-sm text-gray-500">
                            <div class="flex items-center gap-1">
                                <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                SLA正常
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                                SLA预警
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="w-2 h-2 rounded-full bg-red-500"></span>
                                SLA超时
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-4 py-3 text-left w-12"></th>
                                    <th class="px-4 py-3 text-left font-semibold text-gray-700">工单编号</th>
                                    <th class="px-4 py-3 text-left font-semibold text-gray-700">设备信息</th>
                                    <th class="px-4 py-3 text-left font-semibold text-gray-700">故障描述</th>
                                    <th class="px-4 py-3 text-left font-semibold text-gray-700">维修类型</th>
                                    <th class="px-4 py-3 text-left font-semibold text-gray-700">人员与进度</th>
                                    <th class="px-4 py-3 text-left font-semibold text-gray-700">SLA</th>
                                    <th class="px-4 py-3 text-center font-semibold text-gray-700 w-60">操作</th>
                                </tr>
                            </thead>
                            <tbody id="workorder-tbody" class="divide-y"></tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                        <div class="text-sm text-gray-600">显示第 <span id="pagination-range" class="font-semibold text-primary">1 - 10</span> 条，共 <span id="pagination-total" class="font-semibold text-primary">0</span> 条</div>
                        <div class="flex gap-2">
                            <button class="px-3 py-1 border rounded text-sm hover:bg-gray-50 transition-colors" onclick="changePage('prev')">上一页</button>
                            <div id="pagination-pages" class="flex gap-1"></div>
                            <button class="px-3 py-1 border rounded text-sm hover:bg-gray-50 transition-colors" onclick="changePage('next')">下一页</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 工单详情弹窗 -->
    <div id="modal-detail" class="modal">
        <div class="bg-white rounded-lg w-full max-w-6xl max-h-[92vh] overflow-hidden shadow-2xl">
            <div class="flex items-center justify-between p-6 border-b bg-gray-50">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">工单详情</h2>
                    <p class="text-xs text-gray-500 mt-1">完整跟踪工单全生命周期与知识沉淀</p>
                </div>
                <button onclick="closeModal('detail')" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="border-b bg-white">
                <div class="flex px-6 gap-2 overflow-x-auto">
                    <button class="tab-button px-6 py-3 font-medium active" data-tab="basic" onclick="switchDetailTab('basic', this)">
                        <i class="fas fa-info-circle mr-2"></i>基本信息
                    </button>
                    <button class="tab-button px-6 py-3 font-medium" data-tab="fault" onclick="switchDetailTab('fault', this)">
                        <i class="fas fa-bolt mr-2"></i>故障描述
                    </button>
                    <button class="tab-button px-6 py-3 font-medium" data-tab="timeline" onclick="switchDetailTab('timeline', this)">
                        <i class="fas fa-timeline mr-2"></i>执行日志
                    </button>
                    <button class="tab-button px-6 py-3 font-medium" data-tab="spare" onclick="switchDetailTab('spare', this)">
                        <i class="fas fa-gear mr-2"></i>备件耗用
                    </button>
                    <button class="tab-button px-6 py-3 font-medium" data-tab="attachment" onclick="switchDetailTab('attachment', this)">
                        <i class="fas fa-paperclip mr-2"></i>附件文档
                    </button>
                    <button class="tab-button px-6 py-3 font-medium" data-tab="acceptance" onclick="switchDetailTab('acceptance', this)">
                        <i class="fas fa-clipboard-check mr-2"></i>验收评价
                    </button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto" style="max-height: calc(92vh - 192px);">
                <div id="tab-basic" class="detail-tab">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-700 flex items-center mb-3">
                                <i class="fas fa-hashtag text-primary mr-2"></i>工单信息
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span class="text-gray-500">工单编号:</span><span id="detail-code" class="font-medium text-gray-900"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">当前状态:</span><span id="detail-status" class="status-chip bg-blue-100 text-blue-700"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">优先级:</span><span id="detail-priority" class="status-chip bg-yellow-100 text-yellow-700"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">工单类型:</span><span id="detail-repair-type" class="font-medium text-gray-900"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">触发方式:</span><span id="detail-trigger" class="font-medium text-gray-900"></span></div>
                            </div>
                        </div>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-700 flex items-center mb-3">
                                <i class="fas fa-microchip text-success mr-2"></i>设备信息
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span class="text-gray-500">设备编码:</span><span id="detail-equipment-code" class="font-medium text-gray-900"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">设备名称:</span><span id="detail-equipment-name" class="font-medium text-gray-900"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">所属区域:</span><span id="detail-workshop" class="font-medium text-gray-900"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">生产线:</span><span id="detail-line" class="font-medium text-gray-900"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">投产日期:</span><span id="detail-start-date" class="font-medium text-gray-900"></span></div>
                            </div>
                        </div>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-700 flex items-center mb-3">
                                <i class="fas fa-people-arrows text-warning mr-2"></i>人员与SLA</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span class="text-gray-500">报修人:</span><span id="detail-applicant" class="font-medium text-gray-900"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">责任主管:</span><span id="detail-manager" class="font-medium text-gray-900"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">指定工程师:</span><span id="detail-engineer" class="font-medium text-gray-900"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">响应SLA:</span><span id="detail-sla-response" class="font-medium text-gray-900"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">修复SLA:</span><span id="detail-sla-fix" class="font-medium text-gray-900"></span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="tab-fault" class="detail-tab hidden">
                    <div class="bg-white border border-gray-200 rounded-lg p-5">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center"><i class="fas fa-radiation mr-2 text-danger"></i>故障描述与原因分析</h3>
                            <span id="detail-fault-type" class="status-chip bg-red-100 text-red-700"></span>
                        </div>
                        <p id="detail-fault-description" class="text-sm text-gray-700 leading-6"></p>
                        <div id="detail-root-cause" class="mt-5">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">初步根因分析</h4>
                            <ul id="detail-root-cause-list" class="list-disc list-inside text-sm text-gray-600 space-y-1"></ul>
                        </div>
                        <div id="detail-symptom" class="mt-5">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">现场症状记录</h4>
                            <ul id="detail-symptom-list" class="list-disc list-inside text-sm text-gray-600 space-y-1"></ul>
                        </div>
                    </div>
                </div>
                <div id="tab-timeline" class="detail-tab hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="bg-white border border-gray-200 rounded-lg p-5">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                        <i class="fas fa-route mr-2 text-primary"></i>流程执行日志
                                    </h3>
                                    <span id="detail-timeline-duration" class="text-xs text-gray-500"></span>
                                </div>
                                <div id="detail-timeline" class="space-y-4"></div>
                            </div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-5">
                            <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                                <i class="fas fa-gauge-high mr-2 text-warning"></i>SLA进度
                            </h3>
                            <div class="space-y-3 text-sm">
                                <div>
                                    <div class="flex justify-between mb-1"><span class="text-gray-500">响应时长</span><span id="detail-response-time" class="font-medium text-gray-900"></span></div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div id="detail-response-progress" class="bg-blue-500 h-2 rounded-full" style="width: 0"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-1"><span class="text-gray-500">维修时长</span><span id="detail-fix-time" class="font-medium text-gray-900"></span></div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div id="detail-fix-progress" class="bg-green-500 h-2 rounded-full" style="width: 0"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-1"><span class="text-gray-500">待料占比</span><span id="detail-waiting-time" class="font-medium text-gray-900"></span></div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div id="detail-waiting-progress" class="bg-yellow-500 h-2 rounded-full" style="width: 0"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="tab-spare" class="detail-tab hidden">
                    <div class="bg-white border border-gray-200 rounded-lg p-5">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <i class="fas fa-warehouse mr-2 text-success"></i>备件消耗清单
                            </h3>
                            <button onclick="openSpareApply()" class="text-sm text-primary hover:text-blue-700">
                                <i class="fas fa-plus-circle mr-1"></i>申请备件
                            </button>
                        </div>
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-4 py-2 text-left">备件编码</th>
                                    <th class="px-4 py-2 text-left">备件名称</th>
                                    <th class="px-4 py-2 text-left">数量</th>
                                    <th class="px-4 py-2 text-left">领用人</th>
                                    <th class="px-4 py-2 text-left">时间</th>
                                    <th class="px-4 py-2 text-left">备注</th>
                                </tr>
                            </thead>
                            <tbody id="detail-spare-body" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
                <div id="tab-attachment" class="detail-tab hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-paperclip mr-2 text-primary"></i>工单附件
                        </h3>
                        <div class="flex items-center gap-2">
                            <button onclick="uploadWorkOrderAttachment()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                <i class="fas fa-upload mr-2"></i>上传附件
                            </button>
                            <input type="file" id="workorder-attachment-input" class="hidden" onchange="handleWorkOrderAttachment(event)">
                        </div>
                    </div>
                    <div id="detail-attachment-list" class="space-y-2"></div>
                </div>
                <div id="tab-acceptance" class="detail-tab hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white border border-gray-200 rounded-lg p-5">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <i class="fas fa-clipboard-check mr-2 text-success"></i>验收信息
                            </h3>
                            <div class="mt-4 space-y-3 text-sm text-gray-700" id="detail-acceptance-content"></div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-5">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <i class="fas fa-star-half-alt mr-2 text-warning"></i>评价反馈
                            </h3>
                            <div class="mt-4" id="detail-feedback"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 工单表单弹窗 -->
    <div id="modal-form" class="modal">
        <div class="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl">
            <div class="flex items-center justify-between p-6 border-b bg-gray-50">
                <h2 class="text-xl font-bold text-gray-800">新建/编辑工单</h2>
                <button onclick="closeModal('form')" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 180px);">
                <form id="workorder-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">工单编号</label>
                            <input type="text" id="form-code" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus:border-transparent" placeholder="系统自动生成" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">触发方式 *</label>
                            <select id="form-trigger" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus:border-transparent" required>
                                <option value="">请选择</option>
                                <option value="manual">PC人工报修</option>
                                <option value="mobile">移动端扫码</option>
                                <option value="iot">IoT自动报修</option>
                                <option value="inspection">巡检转报修</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">设备 *</label>
                            <input type="text" id="form-equipment" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus:border-transparent" placeholder="设备编码/名称" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">优先级 *</label>
                            <select id="form-priority" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus:border-transparent" required>
                                <option value="urgent">紧急</option>
                                <option value="high">高</option>
                                <option value="medium">中</option>
                                <option value="low">低</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">故障类型 *</label>
                            <select id="form-fault" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus:border-transparent" required>
                                <option value="">请选择</option>
                                <option value="electrical">电气故障</option>
                                <option value="mechanical">机械故障</option>
                                <option value="calibration">校准问题</option>
                                <option value="software">软件故障</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">维修类型 *</label>
                            <select id="form-repair-type" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus:border-transparent" required>
                                <option value="component_replacement">关键元件更换</option>
                                <option value="spare_parts">备品备件更换</option>
                                <option value="tool_repair">工器具维修</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">故障描述 *</label>
                        <textarea id="form-description" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus:border-transparent" rows="4" placeholder="描述故障现象、告警信息、拍照/视频等" required></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">报修人</label>
                            <input type="text" id="form-applicant" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus:border-transparent" placeholder="报修人员姓名">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">联系电话</label>
                            <input type="text" id="form-phone" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus:border-transparent" placeholder="联系方式">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">附件</label>
                            <input type="file" id="form-attachment" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus;border-transparent" multiple>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">计划完成时间</label>
                            <input type="datetime-local" id="form-plan-finish" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus:border-transparent">
                        </div>
                    </div>
                </form>
            </div>
            <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                <button onclick="closeModal('form')" class="px-6 py-2 border rounded-lg hover:bg-gray-100 transition-colors">取消</button>
                <button onclick="saveWorkOrder()" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition-colors">提交工单</button>
            </div>
        </div>
    </div>

    <!-- 派工弹窗 -->
    <div id="modal-assign" class="modal">
        <div class="bg-white rounded-lg w-full max-w-3xl overflow-hidden shadow-2xl">
            <div class="flex items-center justify-between p-6 border-b bg-gray-50">
                <h2 class="text-xl font-bold text-gray-800">派工与资源调度</h2>
                <button onclick="closeModal('assign')" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-5">
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                    <p class"text-sm text-blue-700">已选择 <span id="assign-selected-count" class="font-semibold">0</span> 条工单，可按技能矩阵、区域负责制或负载均衡调度</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">目标工程师 *</label>
                        <select id="assign-engineer" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus:border-transparent" required>
                            <option value="">请选择工程师</option>
                            <option value="li_gong">李工 - 电气高级工程师</option>
                            <option value="wang_gong">王工 - 机械维修主管</option>
                            <option value="zhao_gong">赵工 - 自动化工程师</option>
                            <option value="sun_gong">孙工 - 仪表工程师</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">计划到场时间</label>
                        <input type="datetime-local" id="assign-arrival-time" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">预计维修时长(小时)</label>
                        <input type="number" id="assign-duration" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus;border-transparent" min="1" step="0.5" placeholder="4">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">携带工具/备件</label>
                        <input type="text" id="assign-tools" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus:border-transparent" placeholder="示例：温度传感器X2，扭力扳手">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">派工备注</label>
                    <textarea id="assign-remark" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus:border-transparent" rows="3" placeholder="补充说明维修方案、注意事项、SLA要求等"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                <button onclick="closeModal('assign')" class="px-6 py-2 border rounded-lg hover:bg-gray-100 transition-colors">取消</button>
                <button onclick="assignWorkOrder()" class="px-6 py-2 bg-success text-white rounded-lg hover:bg-green-700 transition-colors">确认派工</button>
            </div>
        </div>
    </div>

    <!-- 进度更新弹窗 -->
    <div id="modal-progress" class="modal">
        <div class="bg-white rounded-lg w-full max-w-3xl overflow-hidden shadow-2xl">
            <div class="flex items-center justify-between p-6 border-b bg-gray-50">
                <h2 class="text-xl font-bold text-gray-800">进度更新与状态流转</h2>
                <button onclick="closeModal('progress')" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">当前工单状态 *</label>
                    <select id="progress-status" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus:border-transparent" required>
                        <option value="in_progress">进行中</option>
                        <option value="waiting_material">待料</option>
                        <option value="pending_acceptance">待验收</option>
                        <option value="closed">完成并关闭</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">开始时间</label>
                        <input type="datetime-local" id="progress-start" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">完成时间</label>
                        <input type="datetime-local" id="progress-end" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus;border-transparent">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">进度说明</label>
                    <textarea id="progress-remark" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-light focus;border-transparent" rows="3" placeholder="记录维修过程、问题排查、待料信息等"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                <button onclick="closeModal('progress')" class="px-6 py-2 border rounded-lg hover:bg-gray-100 transition-colors">取消</button>
                <button onclick="updateProgress()" class="px-6 py-2 bg-warning text-white rounded-lg hover:bg-yellow-600 transition-colors">提交更新</button>
            </div>
        </div>
    </div>

    <!-- 知识库弹窗 -->
    <div id="modal-knowledge" class="modal">
        <div class="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl">
            <div class="flex items-center justify-between p-6 border-b bg-gray-50">
                <h2 class="text-xl font-bold text-gray-800">故障维修知识库</h2>
                <button onclick="closeModal('knowledge')" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex gap-3">
                    <input type="text" id="knowledge-search" placeholder="搜索故障现象/原因/解决方案" class="flex-1 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-primary-light focus:border-transparent" oninput="searchKnowledge()">
                    <select id="knowledge-type" class="w-44 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-primary-light focus;border-transparent" onchange="searchKnowledge()">
                        <option value="">全部分类</option>
                        <option value="electrical">电气故障</option>
                        <option value="mechanical">机械故障</option>
                        <option value="calibration">校准问题</option>
                        <option value="software">软件故障</option>
                    </select>
                </div>
                <div id="knowledge-list" class="space-y-3 max-h-[50vh] overflow-y-auto scrollbar-thin"></div>
            </div>
            <div class="p-6 border-t bg-gray-50 text-xs text-gray-500 flex items-center justify-between">
                <span>• 故障案例沉淀至此，可用于AI辅助诊断 • 支持一键推送至工程师移动端 •</span>
                <button class="text-primary hover:text-blue-700 text-xs" onclick="exportKnowledge()">
                    <i class="fas fa-file-export mr-1"></i>导出知识库
                </button>
            </div>
        </div>
    </div>

    <script src="../../assets/js/equipment-maintenance-repair.js"></script>
</body>
</html>