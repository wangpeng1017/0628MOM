<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设备影子管理 - IOT平台</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#1e40af',
                        'primary-light': '#3b82f6',
                        'secondary': '#6b7280',
                        'success': '#10b981',
                        'warning': '#f59e0b',
                        'danger': '#ef4444'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-sans">
    <div class="p-6">
        <!-- 页面头部 -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">设备影子管理</h1>
                <p class="text-gray-600">Device Shadow - 设备状态缓存与期望状态管理</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="refreshAllShadows()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>
                    刷新全部
                </button>
            </div>
        </div>

        <!-- 设备影子说明 -->
        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg shadow-sm p-6 mb-6 border border-indigo-200">
            <div class="flex items-start">
                <div class="w-12 h-12 bg-indigo-600 rounded-lg flex items-center justify-center mr-4 flex-shrink-0">
                    <i class="fas fa-clone text-white text-xl"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">什么是设备影子？</h3>
                    <p class="text-sm text-gray-700 mb-3">设备影子（Device Shadow）是一个JSON文档，用于存储和检索设备的当前状态信息。即使设备离线，应用程序也可以通过影子获取设备的最后已知状态。</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-lg p-3 border border-indigo-100">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-upload text-blue-600 mr-2"></i>
                                <h4 class="font-semibold text-gray-800 text-sm">Reported State</h4>
                            </div>
                            <p class="text-xs text-gray-600">设备上报的实际状态，由设备主动更新</p>
                        </div>
                        <div class="bg-white rounded-lg p-3 border border-purple-100">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-download text-purple-600 mr-2"></i>
                                <h4 class="font-semibold text-gray-800 text-sm">Desired State</h4>
                            </div>
                            <p class="text-xs text-gray-600">应用程序设置的期望状态，设备会同步此状态</p>
                        </div>
                        <div class="bg-white rounded-lg p-3 border border-orange-100">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-exchange-alt text-orange-600 mr-2"></i>
                                <h4 class="font-semibold text-gray-800 text-sm">Delta</h4>
                            </div>
                            <p class="text-xs text-gray-600">实际状态与期望状态之间的差异</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 设备列表 -->
        <div class="bg-white rounded-lg shadow-sm mb-6">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-800">设备影子列表</h3>
                    <div class="flex items-center space-x-3">
                        <input type="text" placeholder="搜索设备..." class="px-4 py-2 border border-gray-300 rounded-lg text-sm">
                        <select class="px-4 py-2 border border-gray-300 rounded-lg text-sm">
                            <option>全部状态</option>
                            <option>已同步</option>
                            <option>有差异</option>
                            <option>离线</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-200 bg-gray-50">
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">设备名称</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">设备ID</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">影子状态</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">最后更新</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">版本</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-3 px-4 text-sm font-medium text-gray-800">逆变器-PV001</td>
                            <td class="py-3 px-4 text-sm text-gray-600">INV-001-23456</td>
                            <td class="py-3 px-4">
                                <span class="inline-flex px-2 py-1 text-xs font-medium bg-success bg-opacity-10 text-success rounded-full">
                                    <i class="fas fa-check-circle mr-1"></i>已同步
                                </span>
                            </td>
                            <td class="py-3 px-4 text-sm text-gray-600">2 分钟前</td>
                            <td class="py-3 px-4 text-sm text-gray-600">v1.2.5</td>
                            <td class="py-3 px-4">
                                <button onclick="viewShadow('INV-001-23456')" class="text-primary hover:text-primary-light text-sm">
                                    <i class="fas fa-eye mr-1"></i>查看
                                </button>
                            </td>
                        </tr>
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-3 px-4 text-sm font-medium text-gray-800">温度传感器-T001</td>
                            <td class="py-3 px-4 text-sm text-gray-600">TEMP-001-78901</td>
                            <td class="py-3 px-4">
                                <span class="inline-flex px-2 py-1 text-xs font-medium bg-warning bg-opacity-10 text-warning rounded-full">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>有差异
                                </span>
                            </td>
                            <td class="py-3 px-4 text-sm text-gray-600">5 分钟前</td>
                            <td class="py-3 px-4 text-sm text-gray-600">v1.1.8</td>
                            <td class="py-3 px-4">
                                <button onclick="viewShadow('TEMP-001-78901')" class="text-primary hover:text-primary-light text-sm">
                                    <i class="fas fa-eye mr-1"></i>查看
                                </button>
                            </td>
                        </tr>
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-3 px-4 text-sm font-medium text-gray-800">智能电表-M001</td>
                            <td class="py-3 px-4 text-sm text-gray-600">METER-001-45678</td>
                            <td class="py-3 px-4">
                                <span class="inline-flex px-2 py-1 text-xs font-medium bg-gray-100 text-gray-600 rounded-full">
                                    <i class="fas fa-wifi-slash mr-1"></i>离线
                                </span>
                            </td>
                            <td class="py-3 px-4 text-sm text-gray-600">30 分钟前</td>
                            <td class="py-3 px-4 text-sm text-gray-600">v1.0.3</td>
                            <td class="py-3 px-4">
                                <button onclick="viewShadow('METER-001-45678')" class="text-primary hover:text-primary-light text-sm">
                                    <i class="fas fa-eye mr-1"></i>查看
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 设备影子详情（示例） -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-clone text-indigo-600 mr-2"></i>
                    设备影子详情 - 逆变器-PV001
                </h3>
                <div class="flex space-x-2">
                    <button onclick="refreshShadow()" class="px-3 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">
                        <i class="fas fa-sync-alt mr-1"></i>刷新
                    </button>
                    <button onclick="updateDesired()" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                        <i class="fas fa-edit mr-1"></i>更新期望状态
                    </button>
                    <button onclick="clearShadow()" class="px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">
                        <i class="fas fa-eraser mr-1"></i>清除影子
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Reported State -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <h5 class="text-sm font-semibold text-gray-800">
                            <i class="fas fa-upload text-blue-600 mr-2"></i>Reported State (实际状态)
                        </h5>
                        <button onclick="copyJSON('reported')" class="text-xs text-blue-600 hover:text-blue-800">
                            <i class="fas fa-copy mr-1"></i>复制
                        </button>
                    </div>
                    <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                        <pre class="text-xs text-green-400 font-mono">{
  "deviceId": "INV-001-23456",
  "status": "online",
  "timestamp": 1698745200000,
  "properties": {
    "voltage": 220.5,
    "current": 15.2,
    "power": 3350.6,
    "frequency": 50.0,
    "temperature": 45.2,
    "efficiency": 98.5,
    "totalEnergy": 15678.9,
    "runningTime": 28800,
    "errorCount": 0
  },
  "metadata": {
    "lastUpdate": "2025-10-31T13:45:00Z",
    "updateSource": "device",
    "connectionType": "MQTT"
  }
}</pre>
                    </div>
                </div>

                <!-- Desired State -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <h5 class="text-sm font-semibold text-gray-800">
                            <i class="fas fa-download text-purple-600 mr-2"></i>Desired State (期望状态)
                        </h5>
                        <button onclick="copyJSON('desired')" class="text-xs text-purple-600 hover:text-purple-800">
                            <i class="fas fa-copy mr-1"></i>复制
                        </button>
                    </div>
                    <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                        <pre class="text-xs text-purple-400 font-mono">{
  "properties": {
    "targetVoltage": 220.0,
    "targetPower": 3300.0,
    "maxTemperature": 50.0,
    "maintenanceMode": false,
    "autoShutdown": false,
    "powerSaveMode": true
  },
  "metadata": {
    "lastUpdate": "2025-10-31T10:00:00Z",
    "updateSource": "platform",
    "updatedBy": "admin"
  }
}</pre>
                    </div>
                </div>
            </div>

            <!-- Delta -->
            <div class="mt-6">
                <div class="flex items-center mb-3">
                    <h5 class="text-sm font-semibold text-gray-800">
                        <i class="fas fa-exchange-alt text-orange-600 mr-2"></i>Delta (状态差异)
                    </h5>
                </div>
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                    <p class="text-sm text-gray-700 mb-3">当前设备实际状态与期望状态的差异：</p>
                    <div class="bg-white rounded p-4">
                        <pre class="text-xs text-gray-800 font-mono">{
  "voltage": {
    "reported": 220.5,
    "desired": 220.0,
    "delta": +0.5,
    "status": "acceptable"
  },
  "power": {
    "reported": 3350.6,
    "desired": 3300.0,
    "delta": +50.6,
    "status": "acceptable"
  },
  "temperature": {
    "reported": 45.2,
    "desired": "< 50.0",
    "status": "normal"
  }
}</pre>
                    </div>
                    <div class="mt-3 flex items-start">
                        <i class="fas fa-info-circle text-orange-600 mr-2 mt-0.5"></i>
                        <p class="text-xs text-gray-600">
                            设备会自动同步期望状态。当前状态已接近目标值，差异在可接受范围内。
                        </p>
                    </div>
                </div>
            </div>

            <!-- 影子更新历史 -->
            <div class="mt-6">
                <h5 class="text-sm font-semibold text-gray-800 mb-3">
                    <i class="fas fa-history text-gray-600 mr-2"></i>影子更新历史
                </h5>
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">时间</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">类型</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">来源</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">版本</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">变更内容</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-2 text-xs text-gray-600">13:45:23</td>
                                <td class="px-4 py-2"><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">Reported</span></td>
                                <td class="px-4 py-2 text-xs text-gray-600">Device</td>
                                <td class="px-4 py-2 text-xs text-gray-600">v1.2.5</td>
                                <td class="px-4 py-2 text-xs text-gray-600">更新温度、功率数据</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-2 text-xs text-gray-600">10:00:15</td>
                                <td class="px-4 py-2"><span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">Desired</span></td>
                                <td class="px-4 py-2 text-xs text-gray-600">Platform</td>
                                <td class="px-4 py-2 text-xs text-gray-600">v1.2.4</td>
                                <td class="px-4 py-2 text-xs text-gray-600">启用节能模式</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-2 text-xs text-gray-600">08:30:42</td>
                                <td class="px-4 py-2"><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">Reported</span></td>
                                <td class="px-4 py-2 text-xs text-gray-600">Device</td>
                                <td class="px-4 py-2 text-xs text-gray-600">v1.2.3</td>
                                <td class="px-4 py-2 text-xs text-gray-600">设备上线，初始化状态</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 查看设备影子
        function viewShadow(deviceId) {
            alert('查看设备影子: ' + deviceId);
            // 实际应用中，这里会加载对应设备的影子数据
        }

        // 刷新影子
        function refreshShadow() {
            alert('正在刷新设备影子...');
            // 实际应用中，这里会调用API刷新影子数据
        }

        // 刷新所有影子
        function refreshAllShadows() {
            alert('正在刷新所有设备影子...');
        }

        // 更新期望状态
        function updateDesired() {
            alert('打开期望状态编辑器');
            // 实际应用中，这里会打开一个编辑器让用户修改期望状态
        }

        // 清除影子
        function clearShadow() {
            if (confirm('确定要清除设备影子吗？这将删除所有缓存的状态信息。')) {
                alert('设备影子已清除');
            }
        }

        // 复制JSON
        function copyJSON(type) {
            const element = type === 'reported' ? 
                document.querySelector('.text-green-400') : 
                document.querySelector('.text-purple-400');
            
            if (element) {
                navigator.clipboard.writeText(element.textContent).then(() => {
                    alert('JSON已复制到剪贴板');
                });
            }
        }

        // 模拟实时更新
        setInterval(() => {
            const timestamp = document.querySelector('.text-gray-600');
            if (timestamp && timestamp.textContent.includes('分钟前')) {
                // 模拟时间更新
            }
        }, 60000);
    </script>
</body>
</html>
