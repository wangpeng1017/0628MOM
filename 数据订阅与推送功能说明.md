# 数据订阅与推送功能说明

## P0-5: 实现数据订阅与推送

### 功能概述

实现设备数据的订阅与推送机制，支持Kafka、Webhook等多种推送方式，让第三方系统能够实时接收IOT设备数据。

## 核心功能

### 1. 数据订阅管理

用户可以创建订阅规则，指定：
- 订阅的数据源（设备、属性、事件）
- 数据过滤条件
- 推送目标和方式
- 推送频率和批量设置

### 2. 推送方式

#### Kafka推送
```json
{
  "type": "kafka",
  "config": {
    "brokers": ["localhost:9092"],
    "topic": "iot-device-data",
    "partition": 0,
    "compression": "gzip",
    "batchSize": 100,
    "lingerMs": 1000
  }
}
```

#### Webhook推送
```json
{
  "type": "webhook",
  "config": {
    "url": "https://api.example.com/iot/data",
    "method": "POST",
    "headers": {
      "Authorization": "Bearer xxx",
      "Content-Type": "application/json"
    },
    "timeout": 5000,
    "retryCount": 3,
    "retryInterval": 1000
  }
}
```

#### MQTT推送
```json
{
  "type": "mqtt",
  "config": {
    "broker": "mqtt://localhost:1883",
    "topic": "iot/devices/{deviceId}/data",
    "qos": 1,
    "retain": false,
    "clientId": "iot-platform-publisher"
  }
}
```

#### HTTP/HTTPS推送
```json
{
  "type": "http",
  "config": {
    "url": "https://api.example.com/data",
    "method": "POST",
    "headers": {},
    "batchMode": true,
    "batchSize": 50
  }
}
```

### 3. 数据过滤

#### 按设备过滤
```json
{
  "filter": {
    "devices": ["INV-001-23456", "TEMP-001-78901"],
    "deviceTypes": ["逆变器", "传感器"],
    "deviceTags": ["生产线1", "重要设备"]
  }
}
```

#### 按属性过滤
```json
{
  "filter": {
    "properties": ["temperature", "voltage", "current"],
    "includeAll": false
  }
}
```

#### 按条件过滤
```json
{
  "filter": {
    "conditions": [
      {
        "property": "temperature",
        "operator": ">",
        "value": 50
      },
      {
        "property": "status",
        "operator": "==",
        "value": "fault"
      }
    ],
    "logic": "OR"
  }
}
```

### 4. 数据转换

#### 字段映射
```json
{
  "transform": {
    "mapping": {
      "deviceId": "device_id",
      "temperature": "temp",
      "timestamp": "ts"
    }
  }
}
```

#### 数据格式
```json
{
  "transform": {
    "format": "json",  // json, xml, csv
    "template": {
      "device": "{{deviceId}}",
      "data": {
        "temp": "{{temperature}}",
        "time": "{{timestamp}}"
      }
    }
  }
}
```

## 订阅配置界面设计

### 订阅列表页面

```
┌────────────────────────────────────────────────────────────┐
│ 数据订阅与推送                          [+创建订阅] [导入]  │
├────────────────────────────────────────────────────────────┤
│                                                             │
│ 统计卡片：                                                  │
│ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │
│ │活跃订阅 │ │推送成功 │ │推送失败 │ │数据量   │          │
│ │  12     │ │ 98.5%   │ │  1.5%   │ │ 1.2M/天 │          │
│ └─────────┘ └─────────┘ └─────────┘ └─────────┘          │
│                                                             │
│ 订阅列表：                                                  │
│ ┌─────────────────────────────────────────────────────┐   │
│ │订阅名称 │推送方式│数据源│状态│推送次数│最后推送│操作│   │
│ ├─────────────────────────────────────────────────────┤   │
│ │设备数据  │Kafka  │全部  │活跃│125,678 │1分钟前 │编辑│   │
│ │温度告警  │Webhook│传感器│活跃│  1,234 │5分钟前 │编辑│   │
│ │故障事件  │MQTT   │逆变器│停用│      0 │-       │编辑│   │
│ └─────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────┘
```

### 创建订阅页面

```
┌────────────────────────────────────────────────────────────┐
│ 创建数据订阅                                    [保存] [取消]│
├────────────────────────────────────────────────────────────┤
│                                                             │
│ 1. 基本信息                                                 │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ 订阅名称: [_____________________]                    │   │
│ │ 描述: [_________________________________________]    │   │
│ │ 状态: [●活跃 ○停用]                                 │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ 2. 数据源配置                                               │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ 数据类型: [●设备属性 ○设备事件 ○告警数据]           │   │
│ │ 设备筛选: [全部设备▼] [+添加设备]                   │   │
│ │ 属性筛选: [☑temperature ☑voltage ☑current]         │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ 3. 过滤条件（可选）                                         │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ [temperature▼] [>▼] [50] [AND▼] [+添加条件]        │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ 4. 推送配置                                                 │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ 推送方式: [Kafka▼]                                   │   │
│ │                                                      │   │
│ │ Kafka配置:                                           │   │
│ │ Brokers: [localhost:9092_________________]          │   │
│ │ Topic:   [iot-device-data________________]          │   │
│ │ 压缩:    [gzip▼]                                     │   │
│ │                                                      │   │
│ │ 批量设置:                                            │   │
│ │ 批量大小: [100] 条                                   │   │
│ │ 等待时间: [1000] 毫秒                                │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ 5. 数据转换（可选）                                         │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ 输出格式: [JSON▼]                                    │   │
│ │ 字段映射: [配置映射规则...]                          │   │
│ └─────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────┘
```

## 数据推送格式

### 标准JSON格式

```json
{
  "subscriptionId": "sub-001",
  "subscriptionName": "设备数据推送",
  "timestamp": 1698745200000,
  "dataType": "device_property",
  "batchId": "batch-20251031-001",
  "data": [
    {
      "deviceId": "INV-001-23456",
      "deviceName": "逆变器-PV001",
      "deviceType": "逆变器",
      "timestamp": 1698745200000,
      "properties": {
        "temperature": 45.2,
        "voltage": 220.5,
        "current": 15.2,
        "power": 3350.6
      },
      "metadata": {
        "quality": "good",
        "source": "device"
      }
    },
    {
      "deviceId": "TEMP-001-78901",
      "deviceName": "温度传感器-T001",
      "deviceType": "传感器",
      "timestamp": 1698745201000,
      "properties": {
        "temperature": 28.5,
        "humidity": 65.2
      },
      "metadata": {
        "quality": "good",
        "source": "device"
      }
    }
  ]
}
```

### 事件推送格式

```json
{
  "subscriptionId": "sub-002",
  "subscriptionName": "故障事件推送",
  "timestamp": 1698745200000,
  "dataType": "device_event",
  "data": {
    "eventId": "evt-20251031-001",
    "eventType": "fault",
    "deviceId": "INV-001-23456",
    "deviceName": "逆变器-PV001",
    "severity": "high",
    "title": "设备故障",
    "message": "设备温度过高，已触发保护",
    "timestamp": 1698745200000,
    "parameters": {
      "errorCode": 1001,
      "temperature": 75.5,
      "threshold": 65.0
    }
  }
}
```

## 推送监控

### 推送统计

```json
{
  "subscriptionId": "sub-001",
  "statistics": {
    "totalPushes": 125678,
    "successPushes": 123890,
    "failedPushes": 1788,
    "successRate": 98.58,
    "avgLatency": 45,
    "maxLatency": 320,
    "dataVolume": "1.2GB",
    "lastPushTime": "2025-10-31T14:25:00Z"
  }
}
```

### 推送日志

```json
{
  "pushId": "push-20251031-001",
  "subscriptionId": "sub-001",
  "timestamp": "2025-10-31T14:25:00Z",
  "status": "success",
  "recordCount": 100,
  "dataSize": "25KB",
  "latency": 45,
  "target": {
    "type": "kafka",
    "topic": "iot-device-data",
    "partition": 0
  },
  "error": null
}
```

## 错误处理

### 重试机制

```json
{
  "retryPolicy": {
    "enabled": true,
    "maxRetries": 3,
    "retryInterval": 1000,
    "backoffMultiplier": 2,
    "maxInterval": 60000
  }
}
```

### 失败处理

1. **记录失败日志**
2. **发送告警通知**
3. **数据缓存**：失败数据暂存，待恢复后重推
4. **降级策略**：切换到备用推送目标

## API接口设计

### 订阅管理API

```
# 创建订阅
POST /api/subscriptions
Body: {订阅配置}

# 获取订阅列表
GET /api/subscriptions
Query: ?status=active&type=kafka

# 获取订阅详情
GET /api/subscriptions/:id

# 更新订阅
PUT /api/subscriptions/:id
Body: {更新的配置}

# 删除订阅
DELETE /api/subscriptions/:id

# 启用/停用订阅
POST /api/subscriptions/:id/toggle
Body: {"status": "active"}
```

### 推送监控API

```
# 获取推送统计
GET /api/subscriptions/:id/statistics
Query: ?startTime=xxx&endTime=xxx

# 获取推送日志
GET /api/subscriptions/:id/logs
Query: ?page=1&size=20&status=failed

# 测试推送
POST /api/subscriptions/:id/test
Body: {测试数据}
```

## 使用场景

### 场景1：实时数据同步

**需求**：将IOT设备数据实时同步到数据仓库

**配置**：
```yaml
订阅名称: 设备数据实时同步
数据源: 全部设备属性
推送方式: Kafka
Topic: iot-data-sync
批量大小: 100条
等待时间: 1秒
```

### 场景2：告警事件推送

**需求**：设备故障时推送到监控系统

**配置**：
```yaml
订阅名称: 故障告警推送
数据源: 设备事件
过滤条件: eventType == 'fault'
推送方式: Webhook
URL: https://monitor.example.com/api/alerts
重试次数: 3次
```

### 场景3：第三方系统集成

**需求**：将温度数据推送到第三方分析平台

**配置**：
```yaml
订阅名称: 温度数据推送
数据源: 温度传感器
属性: temperature
过滤条件: temperature > 30
推送方式: HTTP
URL: https://analytics.example.com/api/data
数据转换: 自定义JSON格式
```

## 安全机制

### 1. 认证授权

- API Key认证
- OAuth 2.0
- JWT Token
- IP白名单

### 2. 数据加密

- HTTPS/TLS传输加密
- 数据内容加密
- 敏感字段脱敏

### 3. 访问控制

- 基于角色的权限控制
- 订阅配额限制
- 推送频率限制

## 性能优化

### 1. 批量推送

- 合并多条数据为一批
- 减少网络开销
- 提高吞吐量

### 2. 异步处理

- 异步推送，不阻塞数据采集
- 消息队列缓冲
- 多线程并发推送

### 3. 数据压缩

- Gzip压缩
- Snappy压缩
- 减少传输数据量

## 开发状态

**P0-5: 数据订阅与推送**
- ✅ 功能设计完成
- ✅ 数据格式定义完成
- ✅ API接口设计完成
- ⏳ 前端页面开发中
- ⏳ 后端实现待开发

**预计完成时间**: 3-4小时

---

**文档版本**: v1.0  
**创建时间**: 2025-10-31  
**更新时间**: 2025-10-31
