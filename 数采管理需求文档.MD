### **4.1 设备连接与设备全生命周期管理**

#### **4.1.1 设备连接与管理**
（响应要求：支持多种工业协议和网络接入方式...等设备全生命周期管理功能。）

##### **详细功能阐述**

我们的平台设计初衷即是为了解决工业现场设备异构性带来的连接挑战，实现“万物互联”的坚实第一步。

1.  **超广泛的协议与网络兼容性：**
    *   **协议栈深度覆盖：** 我们部署在车间的工业智能网关，其南向驱动库原生支持超过20种主流及非主流工业协议。这包括但不限于：
        *   **现场总线：** Modbus RTU/ASCII (通过串口服务器), Profibus-DP, CANopen, DeviceNet。
        *   **工业以太网：** Modbus TCP, OPC UA (客户端), Profinet, EtherNet/IP, CC-Link IE。
        *   **物联网协议：** MQTT, CoAP, HTTP/HTTPS。
        *   **特定行业/设备协议：** 我们还提供针对电力行业（如IEC 61850, DLT645）、数控机床（如MTConnect, Focas）等特定领域的协议适配能力。
    *   **灵活的自定义协议扩展：** 针对正泰电源可能存在的少量私有协议或非标设备，我们的边缘网关提供插件化的自定义协议开发框架。可通过脚本（如Lua, Python）或二次开发（Java/C++ SDK）的方式，快速实现对新协议的适配，确保工厂内**100%**的设备数据都可被采集。
    *   **全场景网络接入：** 平台支持多样化的网络接入方案，以应对工厂复杂环境：
        *   **有线网络：** 标准以太网接入，稳定可靠。
        *   **无线网络：** 支持Wi-Fi (802.11ac/ax) 接入，便于移动设备（如AGV）或布线困难的设备连接。支持5G工业模组，提供大带宽、低延迟的无线连接。
        *   **低功耗广域网 (LPWAN)：** 支持LoRa, NB-IoT等技术，适用于厂区内分散、低功耗的传感器（如环境监测、消防栓水压监测）的远距离数据回传。

2.  **全面的设备全生命周期管理：**
    *   **远程设备发现与纳管：** 对于支持即插即用协议（如OPC UA）的网络，平台可自动发现网络中的设备并提示管理员进行纳管。
    *   **设备状态的深度监控：** 不仅监控设备是否“在线”，更通过心跳机制、最后上报时间等，精细化判断设备连接质量，实现对“假在线”状态的识别。
    *   **远程配置与诊断：** 经授权的管理员可通过平台下发配置指令，远程修改设备的采集参数、上报频率等，甚至对边缘网关进行远程诊断和重启，极大降低了现场运维的工作量。
    *   **固件升级 (OTA)：** 平台提供可靠的固件升级管理功能，支持对边缘网关及部分智能设备进行远程固件更新。支持分组升级、断点续传、版本回滚等功能，确保升级过程的安全、可控。

---
#### **4.1.2 设备注册与认证**
（响应要求：支持多种设备接入方式...提供设备注册功能...支持安全的设备认证机制...管理设备生命周期。）

##### **详细功能阐述**

安全是工业物联网的生命线。我们构建了银行级的设备身份认证体系，确保每一个接入平台的设备都是可信的，每一条上报的数据来源都是可靠的。

1.  **灵活的设备注册与接入方式：**
    *   **平台预注册：** 最安全、最常用的方式。管理员在平台上为每台设备预先创建数字身份，生成一套唯一的认证凭证（设备三元组：ProductKey, DeviceName, DeviceSecret 或 X.509证书）。现场设备或网关配置此凭证后方可接入。
    *   **动态注册：** 适用于大规模设备部署场景。设备可凭借烧录在固件中的产品密钥，首次上电时向平台发起动态注册请求，平台校验通过后自动为其下发唯一的设备凭证。
    *   **SDK/标准协议接入：** 我们提供多语言的设备端SDK（C, Java, Python等），方便智能化设备直接集成MQTT协议接入平台。对于不便改造的传统设备，则通过边缘网关接入。

2.  **“一机一密”的强安全认证机制：**
    *   **密钥认证 (对称加密)：** 为每台设备分配唯一的`DeviceSecret`，设备使用此密钥对连接请求进行签名，平台使用相同的密钥进行验签。此方式简单高效，适用于资源受限设备。
    *   **X.509证书认证 (非对称加密)：** 安全级别最高的方式。平台为每台设备签发唯一的X.509客户端证书。设备连接时，平台与设备间进行基于PKI体系的双向TLS认证，不仅验证了设备身份，也验证了平台的身份，能有效防止中间人攻击。平台支持对证书的生命周期（签发、吊销）进行管理。
    *   **认证凭证的安全存储与轮换：** 平台侧的密钥和证书均存储在加密的数据库或硬件安全模块(HSM)中。技术上支持密钥的定期自动轮换，进一步增强安全性。

3.  **精细化的设备生命周期管控：**
    *   **激活/禁用：** 管理员可以随时在平台上手动“禁用”某个设备，该设备的所有连接请求将被立即拒绝，适用于设备维修、下线或疑似被攻击的场景。维修完成后可重新“激活”。
    *   **注销：** 对于永久报废的设备，可以执行“注销”操作，彻底删除其在平台上的数字身份和认证凭证，释放资源。所有生命周期操作均有详细的审计日志。

---
#### **4.1.3 设备状态监控**
（响应要求：实时监控已连接设备的在线/离线状态...记录设备上下线时间及原因...向上层应用提供设备连接状态查询接口。）

##### **详细功能阐述**

1.  **毫秒级状态感知与可视化：**
    *   **长连接心跳机制：** 设备与平台建立MQTT长连接后，会按可配置的周期（如30秒）发送心跳包。平台一旦在约定时间内未收到心跳，即可判定设备“离线”。状态变更的感知延迟在秒级。
    *   **实时状态看板：** 平台提供全局的设备状态监控大盘，以拓扑图、列表、饼图等形式，实时展示当前在线设备数、离线设备数、在线率等宏观指标。离线设备会高亮告警。
    *   **设备影子(Device Shadow)：** 平台为每个设备维护一个“设备影子”JSON文档。它缓存了设备的最新上报状态和平台的期望状态。即使设备离线，上层应用依然可以从影子中读取到设备最后一次的在线状态，实现了应用与物理设备的解耦。

2.  **详尽的上下线事件追溯：**
    *   **事件日志：** 每一次设备上线或下线，平台都会生成一条详细的事件日志，记录**设备ID、事件类型（上线/下线）、时间戳**。
    *   **下线原因分析：** 系统能自动分析并记录下线原因，如：
        *   **`CLIENT_CLOSE`：** 设备端主动、正常断开连接。
        *   **`HEARTBEAT_TIMEOUT`：** 心跳超时，通常意味着网络中断或设备死机。
        *   **`SERVER_CLOSE_KICK`：** 被服务器踢下线，例如有其他设备使用相同ID登录。

3.  **标准化的状态服务API：**
    *   我们向上层业务系统（如设备管理系统）提供标准的RESTful API，用于查询设备的连接状态。
    *   `GET /devices/{deviceId}/status`：查询单个设备的实时在线状态。
    *   `POST /devices/status/batch`：批量查询一组设备的状态。
    *   同时，上层应用也可通过订阅特定的MQTT主题（如`/sys/{productKey}/{deviceName}/status`），实时接收设备上下线的事件通知，实现业务的实时联动。

---

### **4.2 数据处理与存储**

#### **4.2.1 数据采集与处理 (边云协同)**
（响应要求：实时、准确地采集设备运行状态、工艺参数...支持边缘计算能力...平台层提供流数据处理引擎...）

##### **详细功能阐述**

我们采用“边缘预处理 + 云端深度分析”的协同模式，对数据进行高效、分层的处理。

1.  **边缘侧-轻量级实时处理：**
    *   **协议解析与原始值采集：** 边缘网关的南向驱动负责与设备PLC通信，按照配置的点位表，以最高100ms/次的频率轮询读取寄存器中的原始数据。
    *   **数据清洗与转换（边缘侧）：**
        *   **工程值转换：** 将读取到的原始值（如4-20mA信号对应的AD值）根据配置的线性变换公式，实时转换为有物理意义的工程值（如0-10MPa）。
        *   **数据类型与格式标准化：** 统一转换为平台定义的标准数据类型（如浮点型、布尔型、字符串）。
        *   **异常值剔除：** 可配置简单的规则，剔除明显超出量程范围的跳变值。
    *   **数据聚合与压缩：** 对于高频采集的数据，边缘网关可进行初步聚合，如将100ms采集一次的电流值，聚合成1秒周期的平均值、最大值、最小值后上报，极大降低了对网络带宽的占用（降低幅度可达60%以上）。

2.  **云端-重量级复杂处理：**
    *   **实时数据流处理：** 平台核心的流处理引擎（基于Apache Flink）对从MQTT Broker接收到的海量数据流进行强大的实时计算。
        *   **窗口计算：** 支持滚动窗口、滑动窗口、会话窗口等，用于计算时间周期内的统计指标，如“计算过去5分钟的平均温度”。
        *   **多流关联：** 可将来自不同设备的数据流进行关联分析，如“当A产线的涂覆机速度超过阈值，且B产线的烘箱温度低于设定值时，触发告警”。
        *   **复杂事件处理(CEP)：** 能够识别复杂的数据模式，如“在1分钟内，如果设备连续发生3次启停，则判断为状态异常”。

---
#### **4.2.2 数据存储与管理**
（响应要求：高效存储海量时序数据...支持冷热数据分层...提供数据模型管理...）

##### **详细功能阐述**

1.  **面向工业场景的混合存储架构：**
    *   **时序数据库(TSDB)：** 我们采用InfluxDB作为核心的时序数据存储引擎。其专为时间序列数据设计的存储结构和查询语言，能够支持每秒数十万数据点的写入，并能在秒级内完成对数亿级数据点的聚合查询，完美匹配工业监控和历史追溯的需求。
    *   **关系型数据库(RDBMS)：** 采用PostgreSQL存储设备的元数据（物模型、设备信息）、事件数据（告警记录、上下线日志）、配置数据等结构化信息。
    *   **分布式文件系统/对象存储：** 用于存储非结构化数据，如伺服压力机上传的完整力-位移曲线文件、设备固件包等。

2.  **智能化的数据生命周期管理 (冷热分层)：**
    *   平台提供可视化的数据生命周期管理策略配置。管理员可以为不同类型的数据设置不同的存储周期。
    *   **热数据层：** 例如，最近30天的数据存储在高性能的SSD上，保证高频查询的性能。
    *   **冷数据层：** 超过30天的数据，系统会自动、平滑地将其迁移到成本更低的HDD或对象存储上。数据在迁移前会进行高效压缩，可节省高达90%的存储空间。
    *   **数据归档与销毁：** 超过指定期限（如2年）的数据，可按策略自动归档到更廉价的离线介质，或进行安全销毁，以满足合规性要求。
    *   **统一查询体验：** 对上层应用而言，查询接口是统一的，无需关心数据具体存储在哪一层，平台会自动路由查询请求，保证了体验的一致性。

3.  **模型驱动的数据模型管理 (物模型/数字孪生)：**
    *   **可视化建模：** 平台提供可视化的物模型编辑器，用户可以通过拖拽的方式，为一类设备（如涂覆机）定义其数字孪生模型。
    *   **TSL三要素：** 物模型遵循标准的TSL（Thing Specification Language）定义，包含三大要素：
        *   **属性(Property)：** 描述设备的静态规格（如型号、额定功率）和实时状态（如当前温度、运行速度）。每个属性都有明确的数据类型、单位、取值范围。
        *   **服务(Service)：** 描述设备可被调用的能力（即下行控制指令），如“设置目标温度”、“启动设备”。
        *   **事件(Event)：** 描述设备主动上报的通知或告警，如“温度超限告警”、“滤网堵塞事件”。
    *   **模型继承与复用：** 支持模型间的继承，便于快速创建相似设备的模型。一个模型创建后，可实例化为成千上万的设备实例，极大简化了设备管理。

---
### **4.3 数据服务与API**

#### **4.3.1 数据查询服务 (API)**
（响应要求：提供API接口...查询最新实时数据...查询历史数据...支持时间范围、数据点、聚合方式...）

##### **详细功能阐述**

平台提供一套标准、高性能、安全可靠的数据服务API，作为所有上层应用的数据消费入口。

1.  **高性能实时数据查询API：**
    *   **接口定义：** `GET /api/v1/devices/realtime-data`
    *   **功能：** 支持批量查询一个或多个设备的指定数据点（或全部数据点）的最新快照值和时间戳。
    *   **性能承诺：** 采用Redis作为一级缓存，缓存设备的最新数据。查询请求首先命中缓存，保证了单次查询响应时间在300ms以内。

2.  **灵活强大的历史数据查询API：**
    *   **接口定义：** `GET /api/v1/devices/history-data`
    *   **功能：** 提供丰富的查询参数，满足各种历史追溯和分析需求：
        *   **`deviceIds`:** 支持查询单个或多个设备。
        *   **`tags`:** 指定要查询的数据点标识符。
        *   **`startTime`, `endTime`:** 毫秒级精度的起止时间戳。
        *   **`limit`, `offset`:** 用于分页查询原始数据点。
        *   **`aggregator`:** 聚合函数，支持`avg`, `max`, `min`, `sum`, `count`等。
        *   **`downsample`:** 降采样/时间窗口聚合。例如，查询过去一个月的数据，可以指定`downsample=1h-avg`，接口将返回以1小时为粒度的平均值序列，而不是海量的原始数据点。
    *   **性能承诺：** 查询近7天数据，响应时间≤1s；查询超过30天数据，响应时间≤3s（支持预加载缓存）。

#### **4.3.2 数据订阅与推送**
（响应要求：支持上层应用通过消息队列...或Webhook等方式订阅...数据变更...平台主动推送...）

##### **详细功能阐述**

为满足上层应用对数据实时性的要求，我们提供“推”模式的数据服务，变“被动拉取”为“主动推送”。

1.  **服务端订阅 (基于消息队列)：**
    *   **集成Kafka：** 平台可以将清洗、处理后的实时数据流，按预定义的主题（Topic）实时写入到高性能的Kafka集群中。
    *   **上层应用消费：** 设备管理、MES等上层系统，作为Kafka的消费者，可以按需订阅自己关心的主题（如`topic-device-status`, `topic-process-data-line1`），即可近乎实时地（ms级延迟）获取数据。
    *   **优点：** 消息队列模式支持发布/订阅、高吞吐、可水平扩展，是大规模系统间实时数据解耦的最佳实践。

2.  **轻量级订阅 (基于Webhook)：**
    *   **配置方式：** 用户可在平台上配置Webhook规则，指定一个HTTP/HTTPS地址。当某个设备的数据满足特定条件（如状态发生变化、某个值超过阈值）时，平台会立即向该地址发起一个POST请求，并将相关数据作为JSON荷载推送过去。
    *   **适用场景：** 适用于与第三方系统（如企业微信机器人、钉钉通知）或轻量级应用进行快速、事件驱动的集成。

---
### **4.4 规则引擎与告警**
（响应要求：提供可视化界面或API...配置告警规则...支持告警等级、抑制、恢复...支持多种通知方式...记录告警事件...）

##### **详细功能阐述**

平台的规则引擎是实现“智能”的核心部件之一，它能够7x24小时不间断地“盯”着数据，并根据预设的业务逻辑自动触发相应动作。

1.  **可视化规则引擎配置：**
    *   我们提供基于Web的拖拽式规则配置界面，用户可以通过“搭积木”的方式构建逻辑。一条规则主要由“触发器（WHEN）”、“条件（IF）”、“动作（THEN）”三部分组成。
    *   **示例：**
        *   **触发器：** 当“涂覆机1号”的“烘箱温度”数据上报时。
        *   **条件：** 如果“烘箱温度 > 200℃”。
        *   **动作：** 则“发送一条‘严重’等级的告警”，并“通过飞书通知‘涂覆班组长’”。

2.  **丰富的规则与告警配置能力：**
    *   **告警等级：** 支持配置提醒、警告、严重、致命等多级别告警。
    *   **告警抑制：** 可配置告警静默期，避免在短时间内对同一问题进行重复轰炸式告警。
    *   **告警恢复：** 当设备数据恢复正常时，系统可自动生成“告警恢复”通知，形成告警事件的闭环。
    *   **时序告警：** 支持更复杂的基于时间的告警，如“如果温度在10分钟内持续高于190℃，则告警”。

3.  **全面的告警管理与通知：**
    *   **告警事件记录：** 所有触发的告警都会被持久化记录，包含告警时间、设备、告警内容、当时值、告警等级等信息，形成可追溯的告警历史库。
    *   **多渠道通知：** 动作库中内置了多种通知插件，包括短信、邮件、APP消息推送、API回调（可通知OA/MES等）、飞书/钉钉机器人。可根据告警等级和设备归属，将告警发送给不同的通知组。

---
### **4.5 数据精度、智能分析与安全性**
（响应要求：数据采集精度与实时性要求...智能分析能力拓展...安全性要求...）

##### **详细功能阐述**

1.  **严格满足数据精度与实时性要求：**
    *   **采集频率：** 我们的边缘网关和平台完全有能力满足并超越您提出的分级采集频率要求。
        *   关键参数（焊接温度、电压波动）：支持≤100ms/次。
        *   设备状态：支持≤1s/次。
        *   能耗数据：支持≤5s/次。
    *   **采集精度：**
        *   模拟量：通过选用高精度AD模块和在边缘侧进行软件滤波，确保采集误差≤±0.5%（量程范围内）。
        *   数字量：响应延迟≤50ms，通过硬件去抖和软件算法，确保无状态误报。
        *   累计量：通过高频采集脉冲或读取寄存器，并结合边缘侧的防重复计数逻辑，确保累计误差≤0.1%。

2.  **智能分析能力拓展：**
    *   本平台作为数据底座，其采集到的海量、高质量数据是上层智能分析应用的基础。平台将通过标准API为以下智能应用提供数据服务：
        *   **设备健康度评估：** 将采集到的设备振动、温度、电流、能耗等多维数据，提供给设备管理系统的机器学习模型，用于生成健康度评分和趋势预测。
        *   **OEE自动计算：** 将采集到的设备运行状态（开机/停机/故障）、运行时间、生产计数值，实时提供给OEE计算引擎，实现按“设备-产线-车间”三级维度的自动化OEE核算，并帮助识别瓶颈工序。
        *   **能耗分析模型：** 将采集的能耗数据与MES的工单数据关联，提供给能源管理系统，用于计算“单位产品能耗”，并自动识别能耗异常。

3.  **全链路、纵深防御的安全性设计：**
    *   **设备接入安全：**
        *   **双向认证：** 严格执行基于“证书+密钥”的双向认证，禁止任何匿名设备接入。
        *   **通信加密：** 网关与平台通信采用TLS 1.3加密，密钥每24小时自动轮换。
        *   **接入权限控制：** 实施基于“设备类型+位置+功能”的细粒度权限模型，权限变更需双人审批并留存日志。
    *   **数据安全全链路管控：**
        *   **传输加密：** 设备至边缘网关采用AES-256加密，边缘至云端采用国密SM4算法。
        *   **存储安全：** 敏感数据（如配置参数）在数据库中采用加密存储，加密密钥与数据分离存储，并定期轮换。历史数据归档前进行完整性校验。
    *   **安全审计与合规：**
        *   每月自动生成安全审计报告，内容包括异常接入尝试次数、数据泄露风险评估、权限变更记录等。
        *   平台设计严格遵循相关信息安全规范，确保交付版本无已知漏洞。

---
### **4.6 系统管理**
（响应要求：用户管理、组织架构管理、角色与权限管理、参数配置、日志管理、数据字典管理。）

##### **详细功能阐述**

平台提供一个功能强大、操作便捷的统一管理后台，确保系统的可运维、可管理。

1.  **统一的用户与组织架构管理：** 提供与公司AD/LDAP集成的能力，实现用户账号的统一认证和单点登录。可在平台内维护与公司一致的部门、班组等组织结构。
2.  **基于RBAC的精细化权限控制：** 管理员可以定义角色（如平台运维、数据分析师、车间主管），并为角色分配不同粒度的权限，包括可访问的设备范围、可操作的API、可查看的管理页面等。
3.  **中心化的配置与字典管理：** 提供系统参数、告警阈值、编码规则、数据字典（如设备类型、故障代码映射）的集中管理界面，所有配置变更均有版本记录和操作日志。
4.  **全面的日志审计：**
    *   **操作日志：** 记录所有管理员在平台上的关键操作，满足“可追溯”的审计要求。
    *   **系统日志：** 通过集成的ELK Stack，提供对平台所有微服务运行日志的集中式检索、分析和可视化，便于快速排查和定位问题。

