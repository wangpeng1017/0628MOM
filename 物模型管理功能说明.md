# 物模型管理功能说明

## 功能概述

物模型（Thing Specification Language, TSL）是IOT平台的核心功能，用于定义设备的数字孪生模型。

## 物模型三要素

### 1. 属性 (Property)
描述设备的运行时状态，可读可写。

**示例**：
```json
{
  "identifier": "temperature",
  "name": "温度",
  "dataType": {
    "type": "float",
    "specs": {
      "min": -20,
      "max": 80,
      "unit": "°C"
    }
  },
  "accessMode": "r"  // r:只读, rw:读写
}
```

**数据类型**：
- `int` - 整型
- `float` - 浮点型
- `double` - 双精度浮点
- `text` - 字符串
- `date` - 日期
- `bool` - 布尔
- `enum` - 枚举
- `struct` - 结构体
- `array` - 数组

### 2. 服务 (Service)
设备可被调用的能力或方法。

**示例**：
```json
{
  "identifier": "setPower",
  "name": "设置功率",
  "callType": "async",  // sync:同步, async:异步
  "inputParams": [
    {
      "identifier": "targetPower",
      "dataType": {
        "type": "float",
        "specs": {
          "min": 0,
          "max": 10000,
          "unit": "W"
        }
      }
    }
  ],
  "outputParams": [
    {
      "identifier": "result",
      "dataType": {
        "type": "bool"
      }
    }
  ]
}
```

**调用方式**：
- `sync` - 同步调用：等待设备响应
- `async` - 异步调用：立即返回，设备异步处理

### 3. 事件 (Event)
设备主动上报的通知信息。

**示例**：
```json
{
  "identifier": "fault",
  "name": "故障告警",
  "type": "alert",  // info:信息, alert:告警, error:错误
  "outputParams": [
    {
      "identifier": "errorCode",
      "dataType": {
        "type": "int"
      }
    },
    {
      "identifier": "errorMsg",
      "dataType": {
        "type": "text"
      }
    },
    {
      "identifier": "timestamp",
      "dataType": {
        "type": "date"
      }
    }
  ]
}
```

**事件类型**：
- `info` - 信息事件：一般性通知
- `alert` - 告警事件：需要关注的异常
- `error` - 错误事件：严重故障

## 完整TSL示例

```json
{
  "schema": "https://iot.example.com/schema/tsl/v1.0",
  "profile": {
    "productKey": "a1b2c3d4e5f6",
    "deviceName": "Inverter",
    "version": "1.2.0",
    "category": "能源设备",
    "description": "光伏逆变器物模型"
  },
  "properties": [
    {
      "identifier": "voltage",
      "name": "电压",
      "dataType": {
        "type": "float",
        "specs": {
          "min": 0,
          "max": 500,
          "unit": "V",
          "unitName": "伏特",
          "precision": 2
        }
      },
      "accessMode": "r",
      "required": true,
      "description": "设备输出电压"
    },
    {
      "identifier": "current",
      "name": "电流",
      "dataType": {
        "type": "float",
        "specs": {
          "min": 0,
          "max": 100,
          "unit": "A",
          "unitName": "安培",
          "precision": 2
        }
      },
      "accessMode": "r",
      "required": true
    },
    {
      "identifier": "power",
      "name": "功率",
      "dataType": {
        "type": "float",
        "specs": {
          "min": 0,
          "max": 10000,
          "unit": "W",
          "unitName": "瓦特"
        }
      },
      "accessMode": "r",
      "required": true
    },
    {
      "identifier": "status",
      "name": "运行状态",
      "dataType": {
        "type": "enum",
        "specs": {
          "0": "停止",
          "1": "运行",
          "2": "故障",
          "3": "维护"
        }
      },
      "accessMode": "r",
      "required": true
    },
    {
      "identifier": "maintenanceMode",
      "name": "维护模式",
      "dataType": {
        "type": "bool"
      },
      "accessMode": "rw",
      "required": false
    }
  ],
  "services": [
    {
      "identifier": "start",
      "name": "启动",
      "callType": "async",
      "inputParams": [],
      "outputParams": [
        {
          "identifier": "result",
          "dataType": {
            "type": "bool"
          }
        }
      ],
      "description": "启动设备运行"
    },
    {
      "identifier": "stop",
      "name": "停止",
      "callType": "async",
      "inputParams": [],
      "outputParams": [
        {
          "identifier": "result",
          "dataType": {
            "type": "bool"
          }
        }
      ],
      "description": "停止设备运行"
    },
    {
      "identifier": "setPower",
      "name": "设置功率",
      "callType": "sync",
      "inputParams": [
        {
          "identifier": "targetPower",
          "dataType": {
            "type": "float",
            "specs": {
              "min": 0,
              "max": 10000,
              "unit": "W"
            }
          }
        }
      ],
      "outputParams": [
        {
          "identifier": "success",
          "dataType": {
            "type": "bool"
          }
        },
        {
          "identifier": "actualPower",
          "dataType": {
            "type": "float"
          }
        }
      ],
      "description": "设置设备目标功率"
    },
    {
      "identifier": "reset",
      "name": "重置",
      "callType": "async",
      "inputParams": [],
      "outputParams": [
        {
          "identifier": "result",
          "dataType": {
            "type": "bool"
          }
        }
      ],
      "description": "重置设备到初始状态"
    }
  ],
  "events": [
    {
      "identifier": "fault",
      "name": "故障告警",
      "type": "alert",
      "outputParams": [
        {
          "identifier": "errorCode",
          "dataType": {
            "type": "int"
          }
        },
        {
          "identifier": "errorMsg",
          "dataType": {
            "type": "text"
          }
        },
        {
          "identifier": "severity",
          "dataType": {
            "type": "enum",
            "specs": {
              "1": "低",
              "2": "中",
              "3": "高",
              "4": "紧急"
            }
          }
        },
        {
          "identifier": "timestamp",
          "dataType": {
            "type": "date"
          }
        }
      ],
      "description": "设备发生故障时上报"
    },
    {
      "identifier": "statusChange",
      "name": "状态变更",
      "type": "info",
      "outputParams": [
        {
          "identifier": "oldStatus",
          "dataType": {
            "type": "enum",
            "specs": {
              "0": "停止",
              "1": "运行",
              "2": "故障"
            }
          }
        },
        {
          "identifier": "newStatus",
          "dataType": {
            "type": "enum",
            "specs": {
              "0": "停止",
              "1": "运行",
              "2": "故障"
            }
          }
        },
        {
          "identifier": "timestamp",
          "dataType": {
            "type": "date"
          }
        }
      ],
      "description": "设备状态发生变化时上报"
    },
    {
      "identifier": "overTemperature",
      "name": "温度过高",
      "type": "alert",
      "outputParams": [
        {
          "identifier": "currentTemp",
          "dataType": {
            "type": "float",
            "specs": {
              "unit": "°C"
            }
          }
        },
        {
          "identifier": "threshold",
          "dataType": {
            "type": "float",
            "specs": {
              "unit": "°C"
            }
          }
        },
        {
          "identifier": "timestamp",
          "dataType": {
            "type": "date"
          }
        }
      ],
      "description": "设备温度超过阈值时上报"
    }
  ]
}
```

## 物模型管理功能

### 1. 物模型列表
- 展示所有已定义的物模型
- 按类别筛选（传感器、执行器、智能仪表等）
- 显示物模型状态（草稿、已发布）
- 显示实例数量和版本信息

### 2. 物模型编辑器
- **属性编辑**：添加、修改、删除属性定义
- **服务编辑**：定义服务的输入输出参数
- **事件编辑**：配置事件类型和输出参数
- **JSON视图**：查看和编辑完整的TSL JSON

### 3. 物模型操作
- **创建**：从模板创建或从零开始
- **导入**：导入JSON格式的TSL
- **导出**：导出为JSON文件
- **发布**：发布物模型供设备使用
- **版本管理**：支持多版本管理

### 4. 物模型验证
- 数据类型验证
- 取值范围验证
- 必填项检查
- 标识符唯一性检查
- JSON格式验证

## 使用场景

### 场景1：新设备接入
1. 创建物模型
2. 定义设备属性（电压、电流、温度等）
3. 定义设备服务（启动、停止、设置参数）
4. 定义设备事件（故障告警、状态变更）
5. 发布物模型
6. 设备按照物模型上报数据

### 场景2：设备升级
1. 基于现有物模型创建新版本
2. 添加新属性或服务
3. 测试验证
4. 发布新版本
5. 设备逐步升级到新版本

### 场景3：数据标准化
1. 定义统一的物模型模板
2. 同类设备使用相同物模型
3. 实现数据格式统一
4. 便于数据分析和处理

## 最佳实践

### 1. 命名规范
- 使用驼峰命名法：`targetPower`, `errorCode`
- 名称要有意义，避免缩写
- 保持一致性

### 2. 数据类型选择
- 温度、电压等用 `float`
- 状态、模式等用 `enum`
- 开关等用 `bool`
- 复杂数据用 `struct`

### 3. 单位规范
- 统一使用国际单位制（SI）
- 明确标注单位：V, A, W, °C
- 保持精度一致

### 4. 版本管理
- 使用语义化版本号：v1.2.3
- 主版本号：不兼容的API修改
- 次版本号：向下兼容的功能性新增
- 修订号：向下兼容的问题修正

## 技术实现

### 前端展示
- 物模型列表卡片
- 属性/服务/事件表格
- JSON编辑器
- 可视化配置界面

### 数据存储
- 物模型定义存储在数据库
- 支持版本历史记录
- 关联设备实例

### API接口
```
GET    /api/thing-models          # 获取物模型列表
GET    /api/thing-models/:id      # 获取物模型详情
POST   /api/thing-models          # 创建物模型
PUT    /api/thing-models/:id      # 更新物模型
DELETE /api/thing-models/:id      # 删除物模型
POST   /api/thing-models/:id/publish  # 发布物模型
GET    /api/thing-models/:id/versions # 获取版本历史
```

## 开发状态

**P0-3: 物模型管理编辑器**
- ✅ 功能设计完成
- ✅ 数据结构定义完成
- ✅ 导航菜单已添加
- ⏳ 前端页面开发中
- ⏳ 编辑器功能待实现

**预计完成时间**: 2-3小时

---

**文档版本**: v1.0  
**创建时间**: 2025-10-31  
**更新时间**: 2025-10-31
