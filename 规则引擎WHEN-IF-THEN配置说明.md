# 规则引擎 WHEN-IF-THEN 可视化配置说明

## P0-4: 增强规则引擎可视化配置

### 功能概述

在现有规则引擎基础上，增加可视化的 WHEN-IF-THEN 规则配置器，让用户通过图形化界面配置复杂的业务规则。

## WHEN-IF-THEN 规则模型

### 规则结构

```
WHEN (触发条件)
  - 定义什么时候触发规则
  - 数据源：设备属性、设备事件、时间条件、外部数据

IF (判断条件)
  - 定义满足什么条件才执行动作
  - 支持多条件组合（AND/OR）
  - 支持持续时间、连续次数等高级条件

THEN (执行动作)
  - 定义触发后执行什么动作
  - 支持多种动作类型：告警、通知、服务调用、数据转发
```

## 可视化配置界面设计

### 1. WHEN 部分（蓝色区块）

**触发条件配置**：
```
┌─────────────────────────────────────────────────────┐
│ WHEN 触发条件                              [+添加条件] │
├─────────────────────────────────────────────────────┤
│ [数据源▼] [设备▼] [属性▼] [触发方式▼] [×]            │
│                                                      │
│ 示例：                                               │
│ 设备属性 | 逆变器-PV001 | temperature | 数据到达      │
└─────────────────────────────────────────────────────┘
```

**触发方式选项**：
- 数据到达：每次收到数据就触发
- 值变化：值发生变化时触发
- 超过阈值：超过设定值时触发
- 定时触发：按时间间隔触发

### 2. IF 部分（绿色区块）

**判断条件配置**：
```
┌─────────────────────────────────────────────────────┐
│ IF 判断条件                                [+添加条件] │
├─────────────────────────────────────────────────────┤
│ [属性▼] [运算符▼] [阈值] [逻辑▼] [×]                 │
│                                                      │
│ 示例：                                               │
│ temperature | > | 65 | AND                          │
│ 持续时间 | >= | 5 | 分钟                             │
└─────────────────────────────────────────────────────┘
```

**运算符选项**：
- `>` 大于
- `>=` 大于等于
- `<` 小于
- `<=` 小于等于
- `==` 等于
- `!=` 不等于
- `in` 在范围内
- `not in` 不在范围内

**高级条件**：
- 持续时间：条件持续满足的时间
- 连续次数：条件连续满足的次数
- 时间窗口：在特定时间段内
- 变化率：值的变化速率

### 3. THEN 部分（橙色区块）

**执行动作配置**：
```
┌─────────────────────────────────────────────────────┐
│ THEN 执行动作                              [+添加动作] │
├─────────────────────────────────────────────────────┤
│ [动作类型▼] [参数配置...] [×]                        │
│                                                      │
│ 示例：                                               │
│ 发送告警 | 级别: 高 | 通知方式: 邮件                  │
└─────────────────────────────────────────────────────┘
```

**动作类型**：

1. **发送告警**
   - 告警级别：低、中、高、紧急
   - 告警标题
   - 告警内容（支持变量）
   - 抑制规则：防止频繁告警

2. **发送通知**
   - 通知方式：邮件、短信、微信、钉钉
   - 接收人/接收组
   - 通知模板

3. **调用服务**
   - 目标设备
   - 服务名称
   - 输入参数

4. **数据转发**
   - 目标系统：Kafka、HTTP、数据库
   - 转发格式：JSON、XML
   - 转发规则

5. **执行脚本**
   - 脚本语言：JavaScript、Python
   - 脚本内容
   - 执行超时

## 规则示例

### 示例1：温度超限告警

```yaml
规则名称: 涂覆机温度超限告警
优先级: 高
状态: 活跃

WHEN:
  - 数据源: 设备属性
    设备: 逆变器-PV001
    属性: temperature
    触发方式: 数据到达

IF:
  - temperature > 65
    AND 持续时间 >= 5 分钟

THEN:
  - 发送告警
    级别: 高
    标题: "设备温度超限"
    内容: "设备 {deviceName} 温度达到 {temperature}°C，超过阈值 65°C"
    通知方式: [邮件, 短信]
    接收人: [运维组, 值班人员]
```

### 示例2：功率异常检测

```yaml
规则名称: 功率异常波动检测
优先级: 中
状态: 活跃

WHEN:
  - 数据源: 设备属性
    设备: 逆变器-PV001
    属性: power
    触发方式: 值变化

IF:
  - power变化率 > 20%
    AND 时间窗口 = 1 分钟内
    OR power < 100W (异常低功率)

THEN:
  - 发送告警
    级别: 中
    标题: "功率异常波动"
  - 调用服务
    设备: 逆变器-PV001
    服务: 进入保护模式
```

### 示例3：复合条件规则

```yaml
规则名称: 设备综合健康检查
优先级: 高
状态: 活跃

WHEN:
  - 数据源: 定时触发
    间隔: 每5分钟

IF:
  - (temperature > 60 AND voltage < 200)
    OR (current > 90 AND power > 9000)
    OR errorCount > 0

THEN:
  - 发送告警
    级别: 高
    标题: "设备健康状态异常"
  - 数据转发
    目标: Kafka
    主题: device-health-alerts
  - 执行脚本
    语言: JavaScript
    内容: "记录异常日志并更新设备状态"
```

## 规则配置JSON格式

```json
{
  "ruleId": "rule-001",
  "ruleName": "涂覆机温度超限告警",
  "priority": "high",
  "status": "active",
  "when": {
    "triggers": [
      {
        "type": "device_property",
        "deviceId": "INV-001-23456",
        "deviceName": "逆变器-PV001",
        "property": "temperature",
        "triggerMode": "on_data_arrival"
      }
    ]
  },
  "if": {
    "conditions": [
      {
        "property": "temperature",
        "operator": ">",
        "value": 65,
        "unit": "°C"
      },
      {
        "logic": "AND",
        "type": "duration",
        "operator": ">=",
        "value": 5,
        "unit": "minutes"
      }
    ]
  },
  "then": {
    "actions": [
      {
        "type": "send_alert",
        "level": "high",
        "title": "设备温度超限",
        "content": "设备 {{deviceName}} 温度达到 {{temperature}}°C，超过阈值 65°C",
        "notificationMethods": ["email", "sms"],
        "recipients": ["ops-team", "duty-staff"],
        "suppressionRule": {
          "enabled": true,
          "interval": 30,
          "unit": "minutes"
        }
      }
    ]
  },
  "metadata": {
    "createdBy": "admin",
    "createdAt": "2025-10-31T14:00:00Z",
    "updatedAt": "2025-10-31T14:00:00Z",
    "version": "1.0.0"
  }
}
```

## 高级特性

### 1. 告警抑制机制

防止短时间内重复告警：
```javascript
{
  "suppressionRule": {
    "enabled": true,
    "interval": 30,        // 抑制时间间隔
    "unit": "minutes",     // 时间单位
    "maxCount": 3,         // 最大重复次数
    "strategy": "sliding"  // 滑动窗口
  }
}
```

### 2. 告警恢复通知

条件恢复正常时发送通知：
```javascript
{
  "recoveryNotification": {
    "enabled": true,
    "title": "设备温度已恢复正常",
    "content": "设备 {{deviceName}} 温度已降至 {{temperature}}°C"
  }
}
```

### 3. 规则优先级

- **紧急 (Critical)**: 立即处理，最高优先级
- **高 (High)**: 优先处理
- **中 (Medium)**: 正常处理
- **低 (Low)**: 延迟处理

### 4. 规则测试

在保存前测试规则：
```javascript
{
  "testData": {
    "temperature": 70,
    "voltage": 220,
    "current": 15
  },
  "expectedResult": {
    "triggered": true,
    "actions": ["send_alert"]
  }
}
```

## UI交互流程

### 创建规则流程

1. **点击"新增规则"按钮**
2. **配置WHEN部分**
   - 选择数据源类型
   - 选择具体设备和属性
   - 设置触发方式
3. **配置IF部分**
   - 添加判断条件
   - 设置运算符和阈值
   - 配置逻辑关系（AND/OR）
4. **配置THEN部分**
   - 选择动作类型
   - 配置动作参数
5. **预览规则**
   - 查看规则的文本描述
   - 查看生成的JSON
6. **测试规则**
   - 输入测试数据
   - 验证规则逻辑
7. **保存并启用**

### 编辑规则流程

1. 在规则列表中点击"编辑"
2. 加载现有规则配置
3. 修改WHEN/IF/THEN任意部分
4. 重新测试
5. 保存更新

## 实现要点

### 前端实现

1. **组件化设计**
   - WhenBlock组件
   - IfBlock组件
   - ThenBlock组件
   - RulePreview组件

2. **状态管理**
   - 使用Vue/React管理规则配置状态
   - 实时更新预览

3. **表单验证**
   - 必填项检查
   - 数据类型验证
   - 逻辑一致性检查

### 后端实现

1. **规则引擎**
   - 规则解析器
   - 条件评估器
   - 动作执行器

2. **规则存储**
   - 数据库表设计
   - 版本管理
   - 历史记录

3. **规则执行**
   - 实时数据流处理
   - 规则匹配
   - 动作触发

## 开发状态

**P0-4: 规则引擎可视化配置**
- ✅ 功能设计完成
- ✅ UI设计完成
- ✅ 规则模型定义完成
- ⏳ 前端组件开发中
- ⏳ 后端API待实现

**预计完成时间**: 3-4小时

---

**文档版本**: v1.0  
**创建时间**: 2025-10-31  
**更新时间**: 2025-10-31
